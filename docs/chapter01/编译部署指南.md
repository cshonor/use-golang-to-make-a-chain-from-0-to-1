# 编译部署指南

## 1.4 编译部署及应用

比原链的安装方式有多种。本书从源码分析的角度带领读者了解架构，所以使用源码编译的方式来介绍安装过程。

---

## 源码编译部署

### 前置要求

- Go 语言环境（建议 Go 1.13+）
- Git
- Make 工具
- 配置好 `GOPATH` 环境变量

---

### 步骤 1：下载源码

```bash
$ git clone https://github.com/Bytom/bytom.git $GOPATH/src/github.com/bytom
```

**说明：**
- 从 GitHub 克隆比原链源码仓库
- 克隆到 Go 工作空间的指定路径：`$GOPATH/src/github.com/bytom`
- 确保 `GOPATH` 环境变量已正确配置

**验证：**
```bash
$ cd $GOPATH/src/github.com/bytom
$ ls
```

---

### 步骤 2：切换至 1.0.5 版本

```bash
$ cd $GOPATH/src/github.com/bytom
$ git fetch origin v1.0.5
$ git checkout v1.0.5
```

**说明：**
- 进入源码目录
- 从远程获取 v1.0.5 版本的代码
- 切换到该版本

**注意：**
- 本书使用 v1.0.5 版本进行讲解
- 其他版本可能有 API 或实现上的差异
- 建议使用指定版本以确保一致性

**验证：**
```bash
$ git branch
$ git tag
```

---

### 步骤 3：编译源码

#### 编译 bytomd（节点进程）

```bash
$ make bytomd
```

**说明：**
- `bytomd` 是比原链的核心进程（daemon）
- 负责运行区块链节点
- 编译完成后会在 `cmd/bytomd` 目录下生成可执行文件

#### 编译 bytomcli（命令行工具）

```bash
$ make bytomcli
```

**说明：**
- `bytomcli` 是比原链的命令行交互工具
- 用于与 `bytomd` 进程交互
- 编译完成后会在 `cmd/bytomcli` 目录下生成可执行文件

**编译所有组件：**
```bash
$ make all
```

**验证编译结果：**
```bash
$ ls -lh cmd/bytomd/bytomd
$ ls -lh cmd/bytomcli/bytomcli
```

---

### 步骤 4：初始化

```bash
$ cd ./cmd/bytomd
$ ./bytomd init --chain_id mainnet
```

**网络类型：**

目前比原链支持三种网络，使用 `chain_id` 进行区分：

#### 1. mainnet（主网）
- **用途**：正式的生产环境网络
- **特点**：真实的区块链网络，需要同步完整数据
- **适用场景**：生产环境部署

#### 2. testnet（测试网，也称 wisdom）
- **用途**：用于测试和开发
- **特点**：测试网络环境，可以免费获取测试币
- **适用场景**：功能测试、集成测试

#### 3. solonet（单机模式）
- **用途**：单机运行模式
- **特点**：独立运行，无需同步区块，快速启动
- **适用场景**：本地开发、学习测试

**初始化作用：**
- 创建配置文件（`config.toml`）
- 初始化数据目录（`data/`）
- 生成创世区块（如果是 solonet）
- 创建必要的数据库文件

**初始化输出：**
```
初始化成功
配置文件：config.toml
数据目录：data/
```

---

### 步骤 5：启动 bytomd 进程

#### 启动节点

```bash
$ ./bytomd node
```

**说明：**
- 启动比原链节点进程
- 节点开始同步区块（mainnet/testnet）或独立运行（solonet）
- 默认监听端口：9888

#### 检查进程状态

**查看进程：**
```bash
$ ps -ef|grep bytomd
```

**输出示例：**
```
501 52318 449 0 2:00PM ttys000 0:00.85 ./bytomd node
```

**字段说明：**
- `501`：用户 ID
- `52318`：进程 ID（PID）
- `449`：父进程 ID（PPID）
- `2:00PM`：启动时间
- `ttys000`：终端
- `0:00.85`：CPU 时间
- `./bytomd node`：命令

**查看端口占用：**
```bash
$ lsof -i :9888
# 或
$ netstat -an | grep 9888
```

---

### 使用 bytomcli 交互

#### 查看网络信息

```bash
$ ./bytomcli net-info
```

**输出内容：**
- 节点连接数
- 当前区块高度
- 网络状态
- 同步进度

#### 其他常用命令

**查看区块链信息：**
```bash
$ ./bytomcli info
```

**查看区块高度：**
```bash
$ ./bytomcli get-block-count
```

**查看帮助：**
```bash
$ ./bytomcli help
```

---

## 部署流程总结

### 完整流程

```
1. 下载源码
   git clone https://github.com/Bytom/bytom.git $GOPATH/src/github.com/bytom
   ↓
2. 切换版本（v1.0.5）
   cd $GOPATH/src/github.com/bytom
   git fetch origin v1.0.5
   git checkout v1.0.5
   ↓
3. 编译源码
   make bytomd
   make bytomcli
   ↓
4. 初始化（选择网络类型）
   cd ./cmd/bytomd
   ./bytomd init --chain_id mainnet|testnet|solonet
   ↓
5. 启动节点
   ./bytomd node
   ↓
6. 使用 bytomcli 交互
   ./bytomcli net-info
```

---

## 网络类型选择建议

### 开发学习阶段

**推荐：solonet（单机模式）**

**优势：**
- ✅ 快速启动，无需同步区块
- ✅ 独立运行，不受网络影响
- ✅ 适合本地开发和测试
- ✅ 可以快速验证功能

**使用场景：**
- 学习区块链原理
- 本地功能开发
- 快速测试验证

---

### 测试验证阶段

**推荐：testnet（测试网）**

**优势：**
- ✅ 连接真实测试网络
- ✅ 可以与其他测试节点交互
- ✅ 免费获取测试币
- ✅ 模拟真实环境

**使用场景：**
- 功能集成测试
- 多节点交互测试
- 网络功能验证

---

### 生产环境

**推荐：mainnet（主网）**

**注意事项：**
- ⚠️ 需要同步完整的区块链数据
- ⚠️ 需要足够的磁盘空间
- ⚠️ 需要稳定的网络连接
- ⚠️ 需要备份重要数据

**使用场景：**
- 正式生产环境
- 真实业务运行

---

## 常见问题排查

### 1. 编译失败

**问题：** `make bytomd` 编译失败

**排查步骤：**
1. 检查 Go 版本
   ```bash
   $ go version
   ```
   需要 Go 1.13 或更高版本

2. 检查依赖
   ```bash
   $ go mod download
   ```

3. 检查 `GOPATH` 配置
   ```bash
   $ echo $GOPATH
   ```

4. 清理后重新编译
   ```bash
   $ make clean
   $ make bytomd
   ```

---

### 2. 初始化失败

**问题：** `./bytomd init` 失败

**排查步骤：**
1. 检查数据目录权限
   ```bash
   $ ls -la data/
   ```

2. 检查磁盘空间
   ```bash
   $ df -h
   ```

3. 检查配置文件格式
   ```bash
   $ cat config.toml
   ```

4. 删除数据目录重新初始化
   ```bash
   $ rm -rf data/
   $ ./bytomd init --chain_id solonet
   ```

---

### 3. 启动失败

**问题：** `./bytomd node` 启动失败

**排查步骤：**
1. 检查端口是否被占用
   ```bash
   $ lsof -i :9888
   ```

2. 检查数据目录是否存在
   ```bash
   $ ls -la data/
   ```

3. 查看日志文件
   ```bash
   $ tail -f logs/bytomd.log
   ```

4. 检查配置文件
   ```bash
   $ cat config.toml
   ```

---

### 4. 节点无法连接

**问题：** 节点无法连接到网络

**排查步骤：**
1. 检查网络连接
   ```bash
   $ ping 8.8.8.8
   ```

2. 检查防火墙设置
   ```bash
   $ sudo ufw status
   ```

3. 检查节点状态
   ```bash
   $ ./bytomcli net-info
   ```

4. 查看节点日志
   ```bash
   $ tail -f logs/bytomd.log
   ```

---

## 实践建议

### 学习路径

1. **第一步：solonet 模式**
   - 快速启动，理解基本概念
   - 学习节点操作
   - 熟悉命令行工具

2. **第二步：testnet 模式**
   - 连接测试网络
   - 体验多节点交互
   - 测试网络功能

3. **第三步：mainnet 模式**
   - 同步主网数据
   - 了解生产环境
   - 学习运维知识

### 开发建议

1. **使用 solonet 进行开发**
   - 快速迭代
   - 不受网络影响
   - 便于调试

2. **使用 testnet 进行测试**
   - 验证网络功能
   - 测试多节点场景
   - 模拟真实环境

3. **定期备份数据**
   - 备份钱包数据
   - 备份配置文件
   - 备份数据库文件

---

## 总结

### 编译部署流程
1. **下载源码** → 克隆 GitHub 仓库
2. **切换版本** → 使用 v1.0.5 版本
3. **编译源码** → 生成可执行文件
4. **初始化** → 选择网络类型
5. **启动节点** → 运行区块链节点

### 网络类型
- **solonet**：单机模式，适合开发学习
- **testnet**：测试网，适合功能测试
- **mainnet**：主网，生产环境

### 关键工具
- **bytomd**：节点进程
- **bytomcli**：命令行工具

### 学习建议
- 从 solonet 开始学习
- 逐步过渡到 testnet
- 最后了解 mainnet

