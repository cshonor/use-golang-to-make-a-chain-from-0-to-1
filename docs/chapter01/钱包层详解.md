# 钱包层详解

## 1.3.4 钱包层

钱包层是比原链架构中负责密钥管理、地址管理、UTXO 维护和交易处理的重要层。

---

## 钱包层概述

### 类比理解

**钱包 = 保险箱**
- 钱包可以类比于我们日常生活中的**保险箱**
- 我们关心保险箱的**开门方式**（密钥）和其中保存的**财产**（UTXO）

### 主要职责

比原链钱包层主要负责：

1. **保存密钥**：安全存储私钥和公钥
2. **管理地址**：生成和管理区块链地址
3. **维护 UTXO 信息**：跟踪和管理未花费的交易输出
4. **处理交易的生成和签名**：构建交易、签名交易
5. **对外提供接口**：提供钱包和交易相关的 API 接口

---

## 钱包层模块架构

### 模块布局

```
┌─────────────────────────────────────────────────┐
│              钱包层（Wallet Layer）              │
├─────────────────────────────────────────────────┤
│  密钥管理  │  公钥管理  │  账户管理  │  资产管理  │
├─────────────────────────────────────────────────┤
│  地址管理  │  Token管理 │  UTXO     │  数据存储  │
└─────────────────────────────────────────────────┘
```

### 8 个核心模块

#### 第一行模块

1. **密钥管理**（Key Management）
   - 私钥的生成、存储和管理
   - 私钥的安全保护（加密存储）
   - 私钥的导入和导出
   - 密钥恢复机制

2. **公钥管理**（Public Key Management）
   - 公钥的生成（从私钥派生）
   - 公钥的存储和管理
   - 公钥的验证
   - 公钥的导出

3. **账户管理**（Account Management）
   - 账户的创建和管理
   - 账户信息的维护
   - 账户权限控制
   - 多账户支持

4. **资产管理**（Asset Management）
   - 资产余额查询
   - 资产转账管理
   - 资产状态跟踪
   - 资产历史记录

#### 第二行模块

5. **地址管理**（Address Management）
   - 地址的生成（从公钥派生）
   - 地址的验证
   - 地址簿管理
   - 地址标签管理

6. **Token 管理**（Token Management）
   - Token 的发行和管理
   - Token 余额查询
   - Token 转账
   - Token 元数据管理

7. **UTXO**（Unspent Transaction Output）
   - UTXO 的查询和管理
   - UTXO 的更新
   - UTXO 的选择（用于交易输入）
   - UTXO 的锁定和解锁

8. **数据存储**（Data Storage）
   - 钱包数据的持久化存储
   - 密钥、地址、UTXO 等数据的存储
   - 数据备份和恢复
   - 数据加密存储

---

## 交易发送流程（三步）

比原链的交易发送分为三步：**Build → Sign → Submit**

### 步骤 1：Build（构建交易）

**作用：**
根据交易的输入和输出，构造交易数据

**详细过程：**

1. **选择交易输入（UTXO）**
   - 查询钱包中的 UTXO
   - 根据转账金额选择合适的 UTXO
   - 确保输入金额 >= 输出金额 + 交易费用

2. **指定交易输出**
   - 设置接收方地址
   - 设置转账金额
   - 计算找零（如果有）

3. **计算交易费用**
   - 根据交易大小计算费用
   - 确保费用足够

4. **构建交易结构**
   - 创建交易对象
   - 填充输入和输出
   - 设置交易版本号等元数据

**结果：**
生成未签名的交易数据

**示例：**
```go
// 伪代码示例
tx := &Transaction{
    Inputs: []*TxInput{
        {UTXO: utxo1, Amount: 100},
        {UTXO: utxo2, Amount: 50},
    },
    Outputs: []*TxOutput{
        {Address: receiverAddr, Amount: 120},
        {Address: changeAddr, Amount: 25}, // 找零
    },
    Fee: 5,
}
```

---

### 步骤 2：Sign（签名交易）

**作用：**
使用私钥对每个交易输入进行签名

**详细过程：**

1. **获取私钥**
   - 根据交易输入获取对应的私钥
   - 从密钥管理中获取私钥

2. **准备签名数据**
   - 对交易数据进行序列化
   - 计算交易的哈希值
   - 准备签名的消息

3. **执行签名**
   - 使用私钥对哈希值进行签名
   - 使用 ECDSA 或其他签名算法
   - 生成数字签名

4. **附加签名**
   - 将签名附加到对应的交易输入中
   - 每个输入都需要单独签名

**结果：**
生成已签名的交易数据

**示例：**
```go
// 伪代码示例
for _, input := range tx.Inputs {
    privateKey := wallet.GetPrivateKey(input.Address)
    hash := tx.CalculateHash()
    signature := Sign(hash, privateKey)
    input.Signature = signature
}
```

**安全要点：**
- 私钥永远不离开钱包
- 签名在本地完成
- 签名过程不可逆

---

### 步骤 3：Submit（提交交易）

**作用：**
将交易提交到网络进行广播，等待打包

**详细过程：**

1. **验证交易完整性**
   - 检查所有输入都已签名
   - 验证签名有效性
   - 检查交易格式正确性

2. **提交到 API Server**
   - 通过 API 接口提交交易
   - 交易进入本地节点

3. **广播到 P2P 网络**
   - 节点将交易广播到网络
   - 其他节点接收并验证交易

4. **进入交易池**
   - 验证通过后进入交易池
   - 等待矿工打包

**结果：**
交易被网络接收，等待矿工打包

**示例：**
```go
// 伪代码示例
// 1. 验证交易
if !tx.Validate() {
    return errors.New("交易验证失败")
}

// 2. 提交到 API Server
response := apiClient.SubmitTransaction(tx)

// 3. 交易进入网络，等待打包
```

---

## 完整交易流程

### 流程图

```
用户发起转账请求
    ↓
┌─────────────────────────────────┐
│  步骤 1：Build（构建交易）       │
│  - 选择 UTXO（输入）             │
│  - 指定接收地址和金额（输出）     │
│  - 计算交易费用                   │
│  - 构建交易结构                   │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  步骤 2：Sign（签名交易）         │
│  - 获取私钥                      │
│  - 计算交易哈希                  │
│  - 使用私钥签名每个输入           │
│  - 附加签名到交易                 │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  步骤 3：Submit（提交交易）       │
│  - 验证交易完整性                │
│  - 提交到 API Server             │
│  - 广播到 P2P 网络               │
│  - 进入交易池等待打包             │
└─────────────────────────────────┘
    ↓
等待矿工打包
    ↓
交易上链
```

---

## 钱包层功能详解

### 密钥管理

**功能：**
- 私钥生成（随机生成或从助记词派生）
- 私钥存储（加密存储）
- 私钥导入/导出
- 密钥恢复

**安全要求：**
- 私钥加密存储
- 不在内存中明文保存
- 支持硬件钱包

### 地址管理

**功能：**
- 地址生成（从公钥派生）
- 地址验证
- 地址簿管理
- 地址标签

**地址生成流程：**
```
私钥 → 公钥 → 地址哈希 → Base58编码 → 地址
```

### UTXO 管理

**功能：**
- UTXO 查询
- UTXO 更新
- UTXO 选择（用于交易）
- UTXO 锁定

**UTXO 选择算法：**
- 按金额选择
- 按时间选择
- 按优先级选择

### 资产管理

**功能：**
- 余额查询
- 资产转账
- 资产历史
- 资产统计

---

## 钱包层接口

### 对外提供的接口

1. **钱包管理接口**
   - 创建钱包
   - 打开钱包
   - 关闭钱包
   - 备份钱包

2. **地址管理接口**
   - 生成地址
   - 查询地址
   - 验证地址

3. **余额查询接口**
   - 查询余额
   - 查询 UTXO
   - 查询资产

4. **交易接口**
   - 构建交易（Build）
   - 签名交易（Sign）
   - 提交交易（Submit）

---

## 学习要点

### 1. 理解钱包的类比
- 钱包 = 保险箱
- 密钥 = 开门方式
- UTXO = 财产

### 2. 理解交易三步流程
- Build：构建交易结构
- Sign：使用私钥签名
- Submit：提交到网络

### 3. 理解各模块的作用
- 密钥管理：安全存储私钥
- 地址管理：生成和管理地址
- UTXO 管理：跟踪未花费输出
- 资产管理：管理资产余额

### 4. 理解安全性要求
- 私钥加密存储
- 签名在本地完成
- 私钥不泄露

---

## 实践建议

### 开发自己的钱包层时

1. **密钥管理**
   - 使用加密存储
   - 支持助记词恢复
   - 支持硬件钱包

2. **UTXO 管理**
   - 高效查询 UTXO
   - 支持 UTXO 选择算法
   - 及时更新 UTXO 状态

3. **交易构建**
   - 智能选择 UTXO
   - 合理计算交易费用
   - 处理找零

4. **交易签名**
   - 安全的签名流程
   - 支持多重签名
   - 签名验证

5. **数据存储**
   - 持久化存储
   - 数据备份
   - 数据恢复

---

## 总结

### 钱包层的核心
- **密钥管理**：安全存储私钥
- **UTXO 管理**：跟踪未花费输出
- **交易处理**：Build → Sign → Submit

### 交易三步流程
1. **Build**：构建交易结构
2. **Sign**：使用私钥签名
3. **Submit**：提交到网络

### 安全性
- 私钥加密存储
- 签名在本地完成
- 私钥不泄露

### 重要性
- 钱包层是用户与区块链交互的入口
- 负责密钥管理和交易处理
- 是区块链系统的重要组成部分

