# 数据存储层详解

## 1.3.6 数据存储层

数据存储层是比原链架构中负责存储所有链上地址、资产交易和其他相关信息的关键层。

---

## 数据存储层概述

### 功能

比原链的数据存储层存储：
- 所有链上地址
- 资产交易信息
- 其他相关信息

### 两层架构

数据存储层分为两个主要部分：

#### 1. 缓存层（Cache）

**作用：**
- 大多数查询首先在缓存中进行
- 减少磁盘 I/O 压力
- 提高查询速度

**特点：**
- 快速访问
- 临时存储
- 内存中存储

#### 2. 持久化存储层（Persistent Storage）

**作用：**
- 如果缓存中没有找到数据，则从持久化存储读取
- 读取后将数据副本添加到缓存中
- 确保数据不丢失

**特点：**
- 永久存储
- 磁盘存储
- 数据持久化

---

## 数据存储层架构

### 架构图

```
┌─────────────────────────────────────┐
│            cache（缓存层）           │
│  - 快速查询                          │
│  - 减少 I/O                          │
└─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────┐
│        数据存储层（接口层）            │
│  - 统一接口                          │
│  - 路由查询                          │
└─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────┐
│            Level DB                  │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐│
│  │acces │ │ core │ │discov│ │trust ││
│  │token │ │      │ │er    │ │hist  ││
│  └──────┘ └──────┘ └──────┘ └──────┘│
│  ┌──────┐ ┌──────┐ ┌──────┐        │
│  │txdb  │ │txfeed│ │wallet│        │
│  └──────┘ └──────┘ └──────┘        │
└─────────────────────────────────────┘
```

---

## LevelDB 数据库

### 定义

**LevelDB：**
- 比原链默认使用的持久化存储数据库
- 由 Google 开发的高效键值数据库
- 基于 LSM-Tree（Log-Structured Merge Tree）结构

### 特点

#### 1. 高效性
- 读写性能优秀
- 适合顺序写入场景
- 支持批量操作

#### 2. 单进程服务
- LevelDB 是单进程服务
- 多个进程不能同时读写同一个数据库
- 同一时间只能有一个进程访问数据库

#### 3. 并发限制
- 支持一个进程的多个并发读写操作
- 不支持多进程并发访问
- 需要进程级别的锁机制

#### 4. 键值存储
- 基于键值对的存储模型
- 支持范围查询
- 支持快照和迭代器

---

## 数据库文件详解

比原链使用 7 个独立的数据库文件（`.db` 文件）：

### 1. accesstoken.db

**内容：**
- 存储令牌信息

**具体用途：**
- 钱包访问控制权限
- 管理访问令牌

**作用：**
- 控制钱包的访问权限
- 管理认证令牌

---

### 2. core.db

**内容：**
- 存储核心数据库

**具体用途：**
- 主链相关数据：
  - **区块信息**（Block Information）
  - **交易信息**（Transaction Information）
  - **资产信息**（Asset Information）

**作用：**
- 存储区块链的核心数据
- 维护主链状态

**重要性：**
- 是最重要的数据库文件
- 包含区块链的核心数据

---

### 3. discover.db

**内容：**
- 存储分布式网络中的端到端节点信息

**具体用途：**
- P2P 网络节点发现相关数据
- 节点连接信息

**作用：**
- 维护网络中的节点信息
- 支持节点发现和连接

---

### 4. trusthistory.db

**内容：**
- 存储分布式网络中的恶意节点信息

**具体用途：**
- 记录不信任的节点历史
- 恶意节点黑名单

**作用：**
- 防止恶意节点攻击
- 维护网络安全
- 记录节点信任历史

---

### 5. txdb.db

**内容：**
- 交易数据库

**具体用途：**
- 存储交易相关数据
- 交易索引和查询

**作用：**
- 管理交易的存储和查询
- 支持交易检索

---

### 6. txfeeds.db

**内容：**
- 交易流数据库

**状态：**
- **当前版本代码中未使用此功能**
- 预留功能，暂未实现

**说明：**
- 未来可能用于交易流相关功能
- 目前不需要关注

---

### 7. wallet.db

**内容：**
- 存储本地钱包数据库

**具体用途：**
- **用户信息**（User Information）
- **资产详情**（Asset Details）
- **交易记录**（Transaction Records）
- **UTXO 信息**（UTXO Information）
- 其他相关数据

**作用：**
- 管理本地钱包的所有数据
- 存储用户的钱包信息
- 维护 UTXO 状态

**重要性：**
- 包含用户的钱包数据
- 需要安全保护
- 建议定期备份

---

## 数据存储位置

### 默认存储位置

**路径规则：**
- 默认存储在 `--home` 参数下的 `data` 目录中

**不同平台的默认路径：**

#### Darwin（macOS）
```
$HOME/Library/Bytom/data
```

#### Linux
```
$HOME/.bytom/data
```

#### Windows
```
%APPDATA%\Bytom\data
```

### 文件结构示例

```
data/
├── accesstoken.db    # 访问令牌数据库
├── core.db           # 核心数据库（最重要）
├── discover.db       # 节点发现数据库
├── trusthistory.db   # 信任历史数据库
├── txdb.db           # 交易数据库
├── txfeeds.db        # 交易流数据库（未使用）
└── wallet.db         # 钱包数据库
```

---

## 缓存机制

### 工作流程

```
查询请求
    ↓
检查缓存（Cache）
    ↓
    ├─→ 缓存命中？
    │       ↓
    │   返回缓存数据
    │   （快速响应）
    │
    └─→ 缓存未命中？
            ↓
        从 LevelDB 读取
            ↓
        添加到缓存
            ↓
        返回数据
```

### 缓存策略

#### LRU（Least Recently Used）
- 最近最少使用的数据被淘汰
- 适合大多数场景

#### LFU（Least Frequently Used）
- 使用频率最低的数据被淘汰
- 适合访问模式固定的场景

#### 定期清理
- 定期清理过期缓存
- 防止缓存占用过多内存

#### 缓存大小限制
- 设置缓存大小上限
- 防止内存溢出

### 优势

**性能提升：**
- ✅ 减少磁盘 I/O 操作
- ✅ 提高查询速度
- ✅ 降低系统负载

**用户体验：**
- ✅ 快速响应
- ✅ 减少等待时间

---

## 数据访问模式

### 读取流程

```
1. 查询请求到达
   ↓
2. 检查缓存
   ↓
3. 缓存命中？
   ├─→ 是：返回缓存数据
   └─→ 否：继续下一步
   ↓
4. 从 LevelDB 读取
   ↓
5. 添加到缓存
   ↓
6. 返回数据
```

### 写入流程

```
1. 写入请求到达
   ↓
2. 写入 LevelDB
   ↓
3. 更新缓存
   ↓
4. 返回成功
```

---

## 学习要点

### 1. 理解两层架构
- 缓存层：快速查询
- 持久化存储层：数据持久化

### 2. 理解 LevelDB 特点
- 单进程服务
- 高效键值数据库
- 并发限制

### 3. 理解各数据库文件的作用
- core.db：核心数据
- wallet.db：钱包数据
- discover.db：节点信息
- trusthistory.db：恶意节点

### 4. 理解缓存机制
- 提高查询速度
- 减少磁盘 I/O
- 缓存策略选择

---

## 实践建议

### 开发自己的数据存储层时

1. **选择合适的数据库**
   - LevelDB：适合顺序写入
   - BoltDB：适合随机读写
   - 根据场景选择

2. **实现缓存机制**
   - 选择合适的缓存策略
   - 设置合理的缓存大小
   - 实现缓存失效机制

3. **数据库文件分离**
   - 不同数据存储在不同文件
   - 便于管理和备份
   - 提高性能

4. **数据备份**
   - 定期备份重要数据
   - 实现数据恢复机制
   - 保护用户数据

5. **性能优化**
   - 批量写入
   - 数据压缩
   - 索引优化

---

## 总结

### 数据存储层的核心
- **两层架构**：缓存层 + 持久化存储层
- **LevelDB**：高效键值数据库
- **7 个数据库文件**：分离存储不同数据
- **缓存机制**：提高查询速度

### 关键数据库文件
- **core.db**：核心数据（最重要）
- **wallet.db**：钱包数据（需备份）
- **discover.db**：节点信息
- **trusthistory.db**：恶意节点

### 重要性
- 数据存储层是区块链的基础设施
- 确保数据不丢失
- 提供高效的数据访问
- 支持系统的正常运行

