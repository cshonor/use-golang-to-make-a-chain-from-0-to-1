# 第一章：公链设计架构 - 学习笔记

## 📅 学习日期
- 开始日期：YYYY-MM-DD
- 完成日期：YYYY-MM-DD

## 📚 核心概念

### 比原链整体架构（7层架构）

比原链采用分层架构设计，从用户交互到运行环境共分为7层：

```
用户交互层
    ↓
接口层
    ↓
内核层
    ↓
钱包层
    ↓
共识层
    ↓
数据存储层
    ↓
P2P分布式网络层
    ↓
运行环境
```

---

### 1. 用户交互层（User Interaction Layer）

用户交互层是用户与比原链系统交互的入口，提供两种交互方式。

#### 1.1 bytomcli 客户端

**定义：**
- `bytomcli` 是一个 RPC 客户端
- 通过命令行建立用户与 `bytomd` 进程之间的通信

**功能：**
- 在部署了比原链的机器上，用户可以使用 `bytomcli` 可执行文件
- 发起各种对比原链的管理请求
- 发送请求后，由 `bytomd` 进程接收并处理

**工作流程：**
```
用户 → bytomcli → RPC请求 → bytomd进程 → 处理请求
```

**生命周期：**
- `bytomcli` 发送请求后，其完整生命周期结束
- 后续处理由 `bytomd` 进程完成

**特点：**
- 命令行交互方式
- 适合开发者和高级用户
- 轻量级，资源占用少

#### 1.2 bytom-dashboard

**定义：**
- `bytom-dashboard` 是比原链的 Web 图形界面

**功能：**
- 与 `bytomcli` 功能相似，都是发送请求并与 `bytomd` 进程建立通信
- 通过 Web 页面与 `bytomd` 进程交互
- 提供更友好的交互体验

**部署：**
- 在部署比原链的机器上，`bytom-dashboard` 功能默认启用
- 无需手动部署

**配置：**
- 用户可以通过传递参数来决定是否启用或禁用该功能
- 示例：传递 `--web.closed` 参数可以禁用该功能

**特点：**
- Web 页面交互方式
- 适合普通用户
- 图形化界面，操作更直观
- 默认启用，可通过参数关闭

**源码地址：**
- GitHub: https://github.com/Bytom/bytom-dashboard

#### 1.3 两种工具对比

| 特性 | bytomcli | bytom-dashboard |
|------|----------|-----------------|
| 交互方式 | 命令行 | Web 页面 |
| 用户群体 | 开发者、高级用户 | 普通用户 |
| 部署方式 | 独立可执行文件 | 默认集成在 bytomd 中 |
| 资源占用 | 轻量级 | 相对较重 |
| 使用场景 | 脚本自动化、调试 | 日常操作、可视化 |

**连接关系：**
- 两者都通过接口层（API Server）与 `bytomd` 进程交互
- 都使用 RPC 协议进行通信

---

### 2. 接口层（Interface Layer）

**组件：**
- `API Server` - API 服务器
- `http server` → `mux router` → `handler` - HTTP 请求处理链路

**功能：**
- 对外暴露系统功能接口
- 处理 HTTP 请求并路由到相应的核心服务
- 提供 RESTful API 接口

**连接关系：**
- `API Server` → 内核层的 `交易管理`
- `handler` → 内核层的 `智能合约`

**实现要点：**
- HTTP 服务器搭建
- 路由管理（mux router）
- 请求处理器（handler）设计

---

### 3. 内核层（Core Layer）- 核心层

这是整个系统的核心，包含区块链的核心逻辑：

#### 3.1 交易管理（Transaction Management）
**子组件：**
- `build` - 构建交易
- `sign` - 签名交易
- `submit` - 提交交易

**功能：**
- 交易的完整生命周期管理
- 交易构建、签名、提交流程

**连接关系：**
- → 钱包层的 `密钥管理`（签名需要私钥）

#### 3.2 BUTXO（Bytom UTXO）
**功能：**
- 比原链的 UTXO 模型实现
- 管理未花费的交易输出

#### 3.3 交易池（Transaction Pool）
**功能：**
- 存储待确认的交易
- 等待被打包进区块的交易管理

#### 3.4 孤块管理（Orphan Block Management）
**功能：**
- 管理父区块尚未被验证的区块
- 处理分叉情况下的区块管理

#### 3.5 智能合约（Smart Contract）
**子组件：**
- `BVM` - Bytom Virtual Machine（比原链虚拟机）
- `Equity` - 资产/权益管理

**功能：**
- 智能合约的执行环境
- 资产发行和管理

**连接关系：**
- → 钱包层的 `资产管理`

#### 3.6 交易验证（Transaction Validation）
**功能：**
- 验证交易的有效性
- 检查交易签名、UTXO 合法性等

**连接关系：**
- → 共识层的 `PoW` 和 `Tensority`

#### 3.7 区块验证（Block Validation）
**功能：**
- 验证区块的有效性
- 检查区块哈希、交易根等

**连接关系：**
- → 共识层的 `PoW` 和 `Tensority`

#### 3.8 数据存储（Data Storage）
**功能：**
- 内核层的数据存储
- 临时数据或特定核心数据存储

---

### 4. 钱包层（Wallet Layer）

**组件：**
- `密钥管理`（Key Management）- 私钥管理
- `公钥管理`（Public Key Management）- 公钥管理
- `账户管理`（Account Management）- 账户管理
- `资产管理`（Asset Management）- 资产管理
- `地址管理`（Address Management）- 地址管理
- `Token 管理`（Token Management）- Token 管理
- `UTXO` - 钱包的 UTXO 管理
- `数据存储`（Data Storage）- 钱包数据存储

**功能：**
- 用户钱包的所有功能
- 密钥生成和管理
- 地址和账户管理
- 资产和 Token 管理

**连接关系：**
- 所有组件 → 数据存储层（持久化存储钱包数据）

---

### 5. 共识层（Consensus Layer）

**组件：**
- `PoW` - 工作量证明共识机制
- `Tensority` - 比原链特有的共识算法（AI/ASIC 友好挖矿）

**功能：**
- 实现网络节点间的共识
- 确定区块的有效性和顺序
- 防止双重支付和网络攻击

**连接关系：**
- → 数据存储层（存储共识相关的数据）

**实现要点：**
- PoW 挖矿算法
- Tensority 算法实现
- 难度调整机制

---

### 6. 数据存储层（Data Storage Layer）

**组件：**
- `cache` - 缓存层
  - `accesstoken` - 访问令牌缓存
  - `core` - 核心区块链数据缓存
  - `discover` - P2P 发现数据缓存
  - `trusthistory` - 信任历史缓存
  - `txdb` - 交易数据库缓存
  - `txfeeds` - 交易流缓存
  - `wallet` - 钱包数据缓存
- `Level DB` - 底层持久化数据库（键值存储）

**功能：**
- 提供可靠高效的数据存储
- 存储区块、交易、账户、网络信息等
- 缓存机制提高访问速度

**连接关系：**
- `Level DB` → P2P 分布式网络层

**实现要点：**
- LevelDB 或 BoltDB 的选择和使用
- 缓存策略设计
- 数据索引优化

---

### 7. P2P 分布式网络层（P2P Distributed Network Layer）

**组件：**
- `discover` - 节点发现机制
- `block sync` - 区块同步
- `tx sync` - 交易同步
- `fast broadcast` - 快速广播

**功能：**
- 实现去中心化的节点通信
- 节点发现和连接
- 区块和交易的同步
- 消息广播机制

**连接关系：**
- → 运行环境

**实现要点：**
- Kademlia DHT 算法（节点发现）
- 区块同步协议
- 交易广播协议
- 网络消息编码/解码

---

### 8. 运行环境（Runtime Environment）

**组件：**
- `宿主机`（Host Machine）
- `云机器`（Cloud Machine）
- `容器`（Container）

**功能：**
- 区块链节点的部署和运行环境
- 支持多种部署方式

---

## 🔄 数据流向分析

### 交易流程
```
用户交互层（bytomcli）
    ↓
接口层（API Server）
    ↓
内核层（交易管理：build → sign → submit）
    ↓
钱包层（密钥管理：签名）
    ↓
内核层（交易验证）
    ↓
共识层（PoW/Tensority）
    ↓
数据存储层（持久化）
    ↓
P2P网络层（广播）
```

### 区块流程
```
P2P网络层（接收区块）
    ↓
内核层（区块验证）
    ↓
共识层（PoW/Tensority）
    ↓
数据存储层（存储区块）
```

### 智能合约流程
```
用户交互层
    ↓
接口层（handler）
    ↓
内核层（智能合约：BVM执行）
    ↓
钱包层（资产管理）
    ↓
数据存储层（存储状态）
```

---

## 💻 代码实现

### 架构设计思路

#### 模块划分原则
1. **分层设计**：每层职责清晰，上层依赖下层
2. **模块化**：每个模块独立，便于开发和测试
3. **接口抽象**：层与层之间通过接口交互
4. **数据流向**：明确数据在各层之间的流转

#### 关键模块对应关系

| 架构层 | 代码模块 | 对应章节 |
|--------|---------|---------|
| 用户交互层 | `cmd/cli/` | 第二章 |
| 接口层 | `internal/api/` | 第四章 |
| 内核层-交易 | `internal/transaction/` | 第六章 |
| 内核层-区块 | `internal/block/`, `internal/blockchain/` | 第五章 |
| 内核层-智能合约 | `internal/contract/` | 第七章 |
| 内核层-虚拟机 | `internal/vm/` | 第八章 |
| 钱包层 | `internal/wallet/` | 第九章 |
| 共识层 | `internal/consensus/pow/`, `internal/consensus/pos/` | 第十二章、第十三章 |
| 数据存储层 | `internal/storage/` | 第十一章 |
| P2P网络层 | `internal/network/` | 第十章 |

#### 实现顺序建议
1. **第一阶段**：数据存储层 + 内核层（区块、交易）
2. **第二阶段**：共识层 + P2P网络层
3. **第三阶段**：钱包层 + 接口层
4. **第四阶段**：智能合约 + 用户交互层

---

## 📊 架构图总结

### 核心设计理念
1. **分层架构**：清晰的层次划分，便于维护和扩展
2. **模块化设计**：每个模块职责单一，高内聚低耦合
3. **数据驱动**：数据在各层之间有序流转
4. **可扩展性**：支持多种共识算法和部署方式

### 关键依赖关系
- **交易管理** 依赖 **密钥管理**（签名）
- **智能合约** 依赖 **资产管理**（资产操作）
- **交易/区块验证** 依赖 **共识层**（共识确认）
- **所有层** 依赖 **数据存储层**（持久化）
- **数据存储层** 依赖 **P2P网络层**（数据同步）

---

## ❓ 遇到的问题

1. **问题描述**：
   - 解决方案：
   - 参考资料：

---

## 📝 学习心得

### 架构理解要点
- [ ] 理解了7层架构的设计思路
- [ ] 理解了各层之间的依赖关系
- [ ] 理解了数据在各层之间的流转
- [ ] 理解了模块划分的原则

### 关键收获
- 分层架构使系统结构清晰，便于开发和维护
- 内核层是系统的核心，包含所有核心逻辑
- 数据存储层和P2P网络层是基础设施
- 钱包层和共识层是区块链的特色功能

---

## 🔗 相关资源

- 《Go 语言公链开发实战》第一章
- 比原链官方文档
- 比原链 GitHub 源码

---

## ✅ 学习检查清单

- [x] 理解比原链的7层架构
- [x] 理解各层的职责和组件
- [x] 理解数据流向和依赖关系
- [ ] 画出自己的架构图
- [ ] 总结各模块的作用和关系
