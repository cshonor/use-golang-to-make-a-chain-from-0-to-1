# P2P 网络和运行机制

> 第三章子文档：P2P 网络初始化和守护进程运行机制详解

---

## 3.6 P2P 网络初始化

### 3.6.1 网络连接的必要性

节点需要连接到 P2P 网络才能：
- ✅ 同步区块数据
- ✅ 广播交易
- ✅ 参与共识
- ✅ 与其他节点通信

### 3.6.2 节点发现机制

#### 种子节点（Seed Nodes）

**什么是种子节点？**
- 由项目核心团队维护的可信节点
- 提供初始的网络连接入口
- 帮助新节点快速加入网络

**如何找到其他节点？**

1. **内置种子节点列表**
   ```go
   // 配置文件中或代码中硬编码的种子节点地址
   seeds := "seed1.bytom.io:46658,seed2.bytom.io:46658"
   ```

2. **连接种子节点**
   - 节点启动时，首先尝试连接种子节点
   - 种子节点返回网络中其他活跃节点的 IP 地址

3. **扩展连接**
   - 连接上种子节点后，获取更多节点地址
   - 逐步扩展连接，加入整个 P2P 网络

**配置种子节点：**
```bash
# 通过命令行参数
bytomd node --p2p.seeds "seed1.bytom.io:46658,seed2.bytom.io:46658"

# 或通过配置文件 config.toml
[p2p]
seeds = "seed1.bytom.io:46658,seed2.bytom.io:46658"
```

### 3.6.3 网络参数配置

**主要网络参数：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `p2p.laddr` | 节点监听地址 | tcp://0.0.0.0:46658 |
| `p2p.seeds` | 种子节点地址列表 | 空 |
| `p2p.max_num_peers` | 最大连接节点数 | 50 |
| `p2p.handshake_timeout` | 握手超时时间（秒） | 30 |
| `p2p.dial_timeout` | 连接超时时间（秒） | 3 |
| `p2p.lan_discoverable` | 是否可被局域网发现 | true |
| `p2p.skip_upnp` | 跳过 UPNP 配置 | false |

### 3.6.4 其他公链的节点发现

**大部分区块链项目的全节点初始化时，都采用类似的方式：**

| 公链 | 节点发现方式 |
|------|------------|
| **比特币** | 内置种子节点列表 |
| **以太坊** | 内置种子节点 + DNS 发现 |
| **比原链** | 内置种子节点列表 |
| **Cosmos** | 内置种子节点 + 持久化节点列表 |

**共同特点：**
- ✅ 都依赖内置的种子节点来启动网络连接
- ✅ 通过种子节点获取更多节点地址
- ✅ 逐步扩展连接，加入整个 P2P 网络

---

## 3.7 守护进程的运行机制

### 3.7.1 持续运行

**RunForever() 实现：**
```go
func (n *Node) RunForever() {
    // 监听系统信号
    cmn.TrapSignal(func() {
        n.Stop()
    })
}
```

**特点：**
- ✅ 只有收到终止信号（SIGINT, SIGTERM）才会退出
- ✅ 保证节点 24 小时在线
- ✅ 优雅关闭，确保数据完整性

### 3.7.2 信号处理

**支持的信号：**
- `SIGINT` (Ctrl+C) - 中断信号
- `SIGTERM` - 终止信号

**优雅关闭流程：**
```
收到终止信号
    ↓
停止接收新请求
    ↓
完成当前处理中的请求
    ↓
关闭网络连接
    ↓
保存数据到磁盘
    ↓
退出进程
```

### 3.7.3 多实例保护

**数据目录锁定：**
- 使用文件锁（flock）防止多个 bytomd 实例同时访问同一数据目录
- 如果检测到已有实例运行，新实例会退出并提示错误

---

**返回**: [bytomd 守护进程详解](./bytomd守护进程详解.md)

