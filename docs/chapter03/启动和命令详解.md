# 启动和命令详解

> 第三章子文档：bytomd 的启动流程和命令行参数详解

---

## 3.4 启动流程：init 和 node 命令的关系

### 3.4.1 两个核心命令的分工

**重要理解：`init` 和 `node` 是先后顺序，不是并列关系**

| 命令 | 作用 | 执行时机 |
|------|------|----------|
| `bytomd init` | 初始化节点环境，创建配置文件、数据目录、生成节点密钥等 | **第一次运行节点前，只需要执行一次** |
| `bytomd node` | 启动守护进程，加载配置、初始化所有模块并进入运行状态 | **每次启动节点都要执行** |

### 3.4.2 完整的启动流程

#### 第一步：初始化（init）

**命令：**
```bash
# 初始化主网节点（也可以用 testnet / solonet）
bytomd init --chain_id mainnet
```

**作用：**
- 生成 `config.toml` 配置文件
- 创建数据目录（存储区块、钱包、密钥）
- 生成节点公私钥对
- 创建目录结构

**重要：**
- ✅ 这一步**只需要做一次**
- ✅ 之后如果不换网络/重装，就不用再执行了
- ✅ 如果配置文件已存在，会提示 "Already exists config file."

**代码实现：**
```go
func initFiles(cmd *cobra.Command, args []string) {
    configFilePath := path.Join(config.RootDir, "config.toml")
    
    // 检查配置文件是否已存在
    if _, err := os.Stat(configFilePath); !os.IsNotExist(err) {
        log.Info("Already exists config file.")
        return
    }
    
    // 根据 chain_id 创建配置文件
    switch config.ChainID {
    case "mainnet", "testnet":
        cfg.EnsureRoot(config.RootDir, config.ChainID)
    default:
        cfg.EnsureRoot(config.RootDir, "solonet")
    }
    
    // 生成节点私钥
    xprv, err := chainkd.NewXPrv(nil)
    // 保存私钥文件
}
```

#### 第二步：启动守护进程（node）

**命令：**
```bash
# 启动节点，开启挖矿和 Web 面板
bytomd node --mining --web.closed=false
```

**作用：**
- 加载 `init` 生成的配置和数据
- 初始化 Node 对象里的所有模块（钱包、同步管理器、API、挖矿等）
- 启动 P2P 网络、同步区块、开启 API 服务
- 进入守护循环，持续运行

**代码实现：**
```go
func runNode(cmd *cobra.Command, args []string) error {
    setLogLevel(config.LogLevel)
    
    // 创建节点对象（初始化所有模块）
    n := node.NewNode(config)
    
    // 启动节点（调用 Node.Start()）
    if err := n.Start(); err != nil {
        log.Fatal("failed to start node")
    }
    
    // 持续运行（进入守护循环）
    n.RunForever()
    return nil
}
```

### 3.4.3 配置初始化流程

**配置加载的优先级顺序：**

比原链的配置初始化遵循以下顺序，确保所有配置项都有合理的值：

```
1. 默认配置（DefaultConfig）
   ↓
2. 配置文件（config.toml）
   ↓
3. 命令行参数（Flags）
   ↓
4. 最终配置传给 node.NewNode(config)
```

#### 步骤 1：设置默认配置

**核心文件分工：**

在比原链的 `config` 文件夹里，核心就是两个文件，分工明确：

| 文件 | 作用 | 职责 |
|------|------|------|
| `config/config.go` | **定义层** | 用结构体声明所有配置项（`BaseConfig`、`P2PConfig` 等），并通过 `DefaultConfig()` 给这些结构体设置**代码默认值** |
| `config/toml.go` | **解析层** | 负责把 `config.toml` 文件里的内容，按照 `config.go` 定义的结构体格式解析出来，然后覆盖掉 `config.go` 里的默认值 |

**代码位置**：
- `config/config.go` - 定义 `DefaultConfig()` 函数和所有配置结构体
- `config/toml.go` - 解析 `config.toml` 文件（或 `config/toml_config.go`，具体文件名需确认源码）
- `cmd/bytomd/commands/root.go` - 调用 `cfg.DefaultConfig()` 和配置文件解析

**配置初始化流程：**

```
1. config.go（定义层）
   ↓
   定义结构体：BaseConfig、P2PConfig、WalletConfig 等
   ↓
   DefaultConfig() 设置代码默认值
   ↓
2. toml.go（解析层）
   ↓
   读取 config.toml 文件
   ↓
   按照结构体格式解析配置
   ↓
   覆盖 config.go 的默认值
   ↓
3. 生成最终配置
   ↓
   传递给 node.NewNode(config)
```

**详细说明：**

**`config.go` - 定义层：**
- ✅ 用结构体声明所有配置项（`BaseConfig`、`P2PConfig`、`WalletConfig` 等）
- ✅ 通过 `DefaultConfig()` 函数给这些结构体设置**代码层面的默认值**
- ✅ 定义配置的"规则"和"骨架"

**`toml.go` - 解析层：**
- ✅ 负责读取 `config.toml` 文件
- ✅ 按照 `config.go` 定义的结构体格式解析 TOML 内容
- ✅ 将解析出的值覆盖 `config.go` 里的默认值
- ✅ 最终生成节点运行用的实际配置

**两者配合：**
- `config.go` 定规则、设默认
- `toml.go` 读文件、改配置
- 两者配合让节点能灵活用配置文件调整参数

**详细过程：**

1. **代码层面的默认值**：
   - `config/config.go` 中的 `DefaultConfig()` 函数给 `BaseConfig` 等模块设置**代码层面的默认值**
   - 例如：`ApiAddress` 的默认值可能被设为 `localhost:9888`
   - 这些是硬编码在代码中的基础默认值

2. **赋值给 BaseConfig**：
   - `root.go` 中通过 `cfg.DefaultConfig()` 调用，将默认值赋值给 `BaseConfig` 结构体
   - 这一步在解析命令行参数和加载配置文件**之前**执行
   - 确保所有配置项都有一个基础默认值

3. **写入 config.toml**：
   - 节点初始化（`bytomd init`）时，会将 `BaseConfig` 的默认值同步写入 `config.toml`
   - 例如：`api_addr = "localhost:9888"` 就是从 `BaseConfig.ApiAddress` 的默认值同步过来的

4. **运行时覆盖**：
   - 如果后期修改 `config.toml` 里的参数（如 `api_addr`），重启节点后这个值会覆盖 `BaseConfig` 的默认值
   - 成为新的运行参数

**常用默认配置项：**
- P2P 端口：`tcp://0.0.0.0:46658`
- API 地址：`0.0.0.0:9888`
- 数据目录：系统默认路径（Windows: `%APPDATA%\Bytom2`，Linux: `$HOME/.bytom`）
- 日志级别：`info`
- 最大连接节点数：`50`

#### 步骤 2：加载配置文件

**配置文件位置**：`config.toml`（由 `bytomd init` 生成）

**解析文件**：`config/toml.go`

**过程：**
1. **读取配置文件**：
   - 如果配置文件存在，`toml.go` 读取 `config.toml` 中的内容
   - 配置文件按网络类型（mainnet/testnet/solonet）有不同的默认值

2. **解析配置**：
   - `toml.go` 按照 `config.go` 定义的结构体格式解析 TOML 内容
   - 将 TOML 中的配置项映射到对应的结构体字段
   - 使用 `mapstructure` 标签进行字段映射（如 `api_addr` → `ApiAddress`）

3. **覆盖默认值**：
   - 解析出的配置值会**覆盖** `config.go` 中 `DefaultConfig()` 设置的默认值
   - 只有 `config.toml` 中存在的配置项才会覆盖，未配置的项保持默认值

**`toml.go` 的核心功能：**
- 读取 `config.toml` 文件内容
- 解析 TOML 格式的配置数据
- 将 TOML 配置映射到 Go 结构体
- 合并配置到已有的默认配置对象中

**示例流程：**
```go
// toml.go 中的解析逻辑
// 1. 读取 config.toml 文件
configData := readConfigFile("config.toml")

// 2. 按照 config.go 定义的结构体格式解析
// 例如：config.toml 中的 api_addr = "0.0.0.0:9888"
// 通过 mapstructure 标签映射到 BaseConfig.ApiAddress 字段

// 3. 覆盖 DefaultConfig() 的默认值
// 如果 config.toml 中有 api_addr，就用配置文件的值
// 如果没有，就用 DefaultConfig() 的默认值
```

#### 步骤 3：解析命令行参数

**过程：**
- 解析 `bytomd node` 命令的所有 Flags
- 命令行参数的值会**覆盖**配置文件和默认配置
- 优先级最高：命令行参数 > 配置文件 > 默认配置

**示例：**
```bash
# 命令行参数会覆盖配置文件中的值
bytomd node --p2p.laddr "tcp://0.0.0.0:46659" --log_level debug
```

#### 步骤 4：传递给 Node

**最终配置：**
- 经过三层覆盖后，得到最终的配置对象
- 传递给 `node.NewNode(config)` 进行节点初始化
- Node 对象使用这个配置初始化所有模块

**代码流程：**
```go
// root.go 中
var cfg = cfg.DefaultConfig()  // 1. 设置默认值

// 解析命令行参数和加载配置文件
// ... 覆盖配置 ...

// run_node.go 中
func runNode(cmd *cobra.Command, args []string) error {
    // config 已经是最终合并后的配置
    n := node.NewNode(config)  // 4. 传递给 Node
    // ...
}
```

**重要理解：**
- ✅ 默认配置确保节点即使没有配置文件也能运行
- ✅ 配置文件允许持久化配置，避免每次启动都输入参数
- ✅ 命令行参数提供最大的灵活性，可以临时覆盖配置
- ✅ 配置优先级：命令行参数 > 配置文件 > 默认配置

### 3.4.4 配置模块结构

**比原链的配置分为 6 个主要模块：**

#### 1. BaseConfig（基础配置）

**作用**：节点的基础配置，用于配置 bytomd 节点所需的基础参数，包括数据目录、日志、监听地址等相关参数。

**代码位置**：`config/config.go`

**完整配置项：**

| 配置项 | mapstructure 标签 | 说明 | 默认值 |
|--------|------------------|------|--------|
| `RootDir` | `home` | 存储配置、keystore、数据的 root 目录 | 系统默认 |
| `ChainID` | `chain_id` | 网络类型，可选 mainnet（主网）、testnet（测试网）、solonet | solonet |
| `LogLevel` | `log_level` | 日志输出级别（debug/info/warn/error/fatal） | info |
| `PrivateKey` | `private_key` | 私钥，用于共识协议的验证 | - |
| `Moniker` | `moniker` | 节点名称，默认情况下为 anonymous | anonymous |
| `ProfListenAddress` | `prof_laddr` | pprof 监听地址，用于查看节点运行时 goroutine、栈信息、CPU 占用等信息。默认不开启 | 空 |
| `FastSync` | `fast_sync` | 块的快速同步机制，默认开启 | true |
| `Mining` | `mining` | 是否启用节点挖矿，默认不开启 | false |
| `FilterPeers` | `filter_peers` | 目前版本该参数未使用 | - |
| `TxIndex` | `tx_index` | 目前版本该参数未使用 | - |
| `DBBackend` | `db_backend` | 比原链数据存储引擎，默认为 LevelDB | leveldb |
| `DBPath` | `db_dir` | 数据存储目录，默认为 `--root` 参数下的 data 目录 | data |
| `KeysPath` | `keys_dir` | keystore 密钥存储，默认路径为 `--root` 参数下的 keystore 目录 | keystore |
| `HsmUrl` | `hsm_url` | 目前版本该参数未使用 | - |
| `ApiAddress` | `api_addr` | API Server 本地监听的地址，默认为 `0.0.0.0:9888` | 0.0.0.0:9888 |
| `VaultMode` | `vault_mode` | vault 无网络模式 | false |
| `Time` | - | 目前版本该参数未使用 | - |
| `LogFile` | `log_file` | 文件日志输出路径 | log |

**核心参数说明（节点运行的"基础骨架"）：**

| 参数 | 作用 | 重要性 |
|------|------|--------|
| `RootDir` (home) | 数据存储的根目录，所有区块、钱包、配置文件都存在这里 | ⭐⭐⭐⭐⭐ 核心 |
| `ChainID` (chain_id) | 指定连接主网还是测试网，决定网络参数和种子节点 | ⭐⭐⭐⭐⭐ 核心 |
| `LogLevel` (log_level) | 控制日志详细程度，调试时可以设为 `debug` | ⭐⭐⭐⭐ 重要 |
| `ApiAddress` (api_addr) | API Server 监听地址，外部访问的入口 | ⭐⭐⭐⭐⭐ 核心 |
| `DBBackend` (db_backend) | 数据存储引擎类型，默认 LevelDB | ⭐⭐⭐⭐ 重要 |
| `DBPath` (db_dir) | 数据存储目录，默认在 `RootDir/data` | ⭐⭐⭐⭐ 重要 |
| `KeysPath` (keys_dir) | keystore 密钥存储目录，默认在 `RootDir/keystore` | ⭐⭐⭐⭐ 重要 |
| `ProfListenAddress` (prof_laddr) | 性能分析的监听地址，开发时才会用到 | ⭐⭐ 可选 |
| `FastSync` (fast_sync) | 快速同步机制开关，默认开启 | ⭐⭐⭐ 常用 |
| `Mining` (mining) | 挖矿开关，默认不开启 | ⭐⭐⭐ 常用 |

**默认值示例：**
- `RootDir`（home）：默认是用户目录下的 `.bytom` 文件夹（Linux）或 `%APPDATA%\Bytom2`（Windows）
- `ChainID`：默认 `solonet`（独立网络）
- `LogLevel`：默认 `info`
- `ApiAddress`：默认 `0.0.0.0:9888`
- `FastSync`：默认 `true`
- `Mining`：默认 `false`

**重要理解：**
- ✅ 这些参数如果不通过命令行或 `config.toml` 修改，就用 `DefaultConfig()` 里的默认值
- ✅ `RootDir` 是节点数据的"家"，所有数据都存储在这里
- ✅ `ChainID` 决定了节点连接哪个网络，影响种子节点和网络参数
- ✅ `LogLevel` 在生产环境通常用 `info`，调试时用 `debug`
- ✅ `ProfListenAddress` 只在需要性能分析时开启，生产环境通常关闭

**配置模板来源：**

默认配置值可以从 `config/toml.go` 文件中的配置模板获取：

```go
// 默认配置模板
var defaultConfigTmpl = `
# This is a TOML config file.
fast_sync = true
db_backend = "leveldb"
api_addr = "0.0.0.0:9888"
`

// 主网配置模板
var mainNetConfigTmpl = `
chain_id = "mainnet"
[p2p]
laddr = "tcp://0.0.0.0:46657"
seeds = "45.79.213.28:46657,198.74.61.131:46657,..."
`
```

**示例：**
```toml
[base]
chain_id = "solonet"
root_dir = "/path/to/data"
log_level = "info"
api_addr = "0.0.0.0:9888"
fast_sync = true
mining = false
```

#### 2. P2PConfig（P2P 网络配置）

**作用**：P2P 网络相关配置

**代码位置**：`config/config.go`

**结构体定义**：
- `P2PConfig` 是一个结构体（struct），和 `BaseConfig` 一样
- 所有配置模块都是用结构体定义的，包括 `P2PConfig`、`WalletConfig`、`AuthConfig`、`WebConfig`、`CmtdConfig` 等

**P2PConfig 结构体字段：**

| 字段名 | mapstructure 标签 | 说明 | 默认值 |
|--------|------------------|------|--------|
| `Seeds` | `seeds` | 种子节点地址列表（逗号分隔） | 空 |
| `ListenAddress` | `laddr` | P2P 监听地址 | `tcp://0.0.0.0:46658` |
| `MaxNumPeers` | `max_num_peers` | 最大连接节点数 | 50 |
| `HandshakeTimeout` | `handshake_timeout` | 握手超时时间（秒） | 30 |
| `DialTimeout` | `dial_timeout` | 连接超时时间（秒） | 3 |
| `LanDiscoverable` | `lan_discoverable` | 是否可被局域网发现 | true |
| `SkipUPNP` | `skip_upnp` | 跳过 UPNP 配置 | false |
| `ProxyAddress` | `proxy_address` | SOCKS5 代理地址 | 空 |
| `ProxyUsername` | `proxy_username` | 代理用户名 | 空 |
| `ProxyPassword` | `proxy_password` | 代理密码 | 空 |
| `KeepDial` | `keep_dial` | 保持连接的节点地址 | 空 |

**常用配置项：**
- `laddr` - P2P 监听地址（默认：`tcp://0.0.0.0:46658`）
- `seeds` - 种子节点地址列表（逗号分隔）
- `max_num_peers` - 最大连接节点数（默认：50）
- `handshake_timeout` - 握手超时时间（秒）
- `dial_timeout` - 连接超时时间（秒）
- `lan_discoverable` - 是否可被局域网发现

**示例：**
```toml
[p2p]
laddr = "tcp://0.0.0.0:46658"
seeds = "seed1.bytom.io:46658,seed2.bytom.io:46658"
max_num_peers = 50
handshake_timeout = 30
dial_timeout = 3
```

#### 3. WalletConfig（钱包配置）

**作用**：钱包功能相关配置

**代码位置**：`config/config.go`

**结构体定义**：
- `WalletConfig` 是一个结构体（struct）

**WalletConfig 结构体字段：**

| 字段名 | mapstructure 标签 | 说明 | 默认值 |
|--------|------------------|------|--------|
| `Disable` | `disable` | 是否禁用钱包功能 | false |
| `Rescan` | `rescan` | 是否重新扫描钱包 | false |
| `TxIndex` | `txindex` | 是否保存全局交易索引 | false |

**常用配置项：**
- `disable` - 是否禁用钱包功能（默认：false）
- `rescan` - 是否重新扫描钱包（默认：false）
- `txindex` - 是否保存全局交易索引（默认：false）

**示例：**
```toml
[wallet]
disable = false
rescan = false
txindex = false
```

#### 4. AuthConfig（认证配置）

**作用**：API 访问权限配置

**代码位置**：`config/config.go`

**结构体定义**：
- `AuthConfig` 是一个结构体（struct）

**AuthConfig 结构体字段：**

| 字段名 | mapstructure 标签 | 说明 | 默认值 |
|--------|------------------|------|--------|
| `Disable` | `disable` | 是否禁用 RPC 访问认证 | false |
| `TokenExpiration` | `token_expiration` | 访问令牌过期时间 | - |

**常用配置项：**
- `disable` - 是否禁用 RPC 访问认证（默认：false）
- `token_expiration` - 访问令牌过期时间

**示例：**
```toml
[auth]
disable = false
```

#### 5. WebConfig（Web面板配置）

**作用**：Web Dashboard 相关配置

**代码位置**：`config/config.go`

**结构体定义**：
- `WebConfig` 是一个结构体（struct）

**WebConfig 结构体字段：**

| 字段名 | mapstructure 标签 | 说明 | 默认值 |
|--------|------------------|------|--------|
| `Closed` | `closed` | 是否关闭 Web 界面 | false |
| `Enable` | `enable` | 是否启用 Web 界面 | true |
| `ApiAddress` | `api_addr` | API 服务地址 | `0.0.0.0:9888` |

**常用配置项：**
- `closed` - 是否关闭 Web 界面（默认：false）
- `enable` - 是否启用 Web 界面（默认：true）
- `api_addr` - API 服务地址（默认：`0.0.0.0:9888`）

**示例：**
```toml
[web]
closed = false
api_addr = "0.0.0.0:9888"
```

#### 6. CmtdConfig（模拟配置）

**作用**：模拟相关配置（可能是 Simd 的配置）

**代码位置**：`config/config.go`

**结构体定义**：
- `CmtdConfig` 是一个结构体（struct）

**说明**：此模块的具体配置项需要查看源码确认

### 3.4.5 配置结构体的组合

**所有配置模块的组合：**

在 `config/config.go` 中，所有配置模块的结构体最终会被组合进一个大的 `Config` 结构体：

```go
type Config struct {
    BaseConfig   BaseConfig   // 基础配置
    P2PConfig    P2PConfig   // P2P 网络配置
    WalletConfig WalletConfig // 钱包配置
    AuthConfig   AuthConfig   // 认证配置
    WebConfig    WebConfig    // Web 面板配置
    CmtdConfig   CmtdConfig   // 模拟配置
}
```

**配置初始化流程：**

1. **定义结构体**：每个配置模块都有自己的结构体（`BaseConfig`、`P2PConfig` 等）
2. **设置默认值**：`DefaultConfig()` 函数为每个结构体的字段设置默认值
3. **组合成 Config**：所有配置模块组合成一个 `Config` 结构体
4. **传递给 Node**：`node.NewNode(config)` 通过一个配置对象获取所有模块的参数

**优势：**
- ✅ 模块化设计，每个功能模块的配置独立管理
- ✅ 类型安全，通过结构体字段访问配置
- ✅ 易于扩展，添加新配置模块只需定义新的结构体
- ✅ 统一管理，通过一个 `Config` 对象访问所有配置

### 3.4.5 如何修改配置

**修改配置的三种方式：**

#### 方式 1：修改 config.toml 文件（推荐）

**步骤：**
1. 找到配置文件：`<数据目录>/config.toml`
2. 编辑配置文件，修改对应模块的配置项
3. 重启节点使配置生效

**优点：**
- ✅ 配置持久化，重启后仍然有效
- ✅ 不需要每次启动都输入命令行参数
- ✅ 适合生产环境

**示例：**
```bash
# 1. 编辑配置文件
vim ~/.bytom/config.toml

# 2. 修改配置（例如修改 P2P 端口）
[p2p]
laddr = "tcp://0.0.0.0:46659"  # 修改端口

# 3. 重启节点
bytomd node
```

#### 方式 2：使用命令行参数

**步骤：**
- 在启动命令时添加 `--` 前缀的参数

**优点：**
- ✅ 临时覆盖配置，不影响配置文件
- ✅ 适合测试和调试

**示例：**
```bash
# 临时修改 P2P 端口和日志级别
bytomd node --p2p.laddr "tcp://0.0.0.0:46659" --log_level debug
```

#### 方式 3：修改源码（不推荐）

**说明：**
- 默认配置定义在 `config/config.go` 的 `DefaultConfig()` 函数中
- 修改源码需要重新编译
- **不推荐**，除非是开发或定制化需求

**配置优先级总结：**
```
命令行参数 > config.toml > 默认配置（DefaultConfig）
```

**重要提示：**
- ✅ **推荐使用方式 1**：修改 `config.toml` 文件
- ✅ 修改配置后需要**重启节点**才能生效
- ✅ 命令行参数会临时覆盖配置文件，但不会修改配置文件本身
- ✅ 配置文件不存在时，使用默认配置也能正常运行

### 3.4.4 Node.Start() 方法的作用

**重要理解：**

- ❌ **不是**先 `start` 再 `init`，而是先 `init` 再 `node`
- ❌ `init` **不是**每次启动都要做，只做一次
- ✅ `node` 才是每次启动节点都要执行的命令

**Node.Start() 执行顺序：**

```go
func (n *Node) OnStart() error {
    // 1. 启动 API 服务器（这是唯一对外的入口）
    n.api.StartServer(*listenAddr)
    
    // 2. 启动区块提议者（如果启用挖矿）
    if n.miningEnable {
        n.blockProposer.Start()
    }
    
    // 3. 启动网络同步管理器（P2P 网络）
    if err := n.syncManager.Start(); err != nil {
        return err
    }
    
    // 4. 启动 WebSocket 通知管理器
    if err := n.notificationMgr.Start(); err != nil {
        return err
    }
    
    return nil
}
```

**启动后的状态：**
- ✅ API Service 监听 `http://localhost:9888`
- ✅ P2P 网络开始连接其他节点
- ✅ 区块同步开始
- ✅ 如果启用挖矿，开始挖矿
- ✅ 等待 CLI 或 Web 界面的请求

### 3.4.4 常见误区澄清

| 误区 | 正确理解 |
|------|---------|
| ❌ 先 start 再 init | ✅ 先 init 再 node |
| ❌ init 每次启动都要做 | ✅ init 只做一次 |
| ❌ node 命令就是 start | ✅ node 命令内部调用 Node.Start() |
| ❌ CLI 直接连接数据库 | ✅ CLI 通过 API Service 访问 |
| ❌ CLI 直接连接 P2P | ✅ CLI 通过 API Service 访问 |

### 3.4.5 完整启动示例

**场景：第一次启动比原链节点**

```bash
# 步骤 1：初始化（只需要执行一次）
bytomd init --chain_id solonet

# 步骤 2：启动节点（每次启动都要执行）
bytomd node

# 步骤 3：验证节点运行（使用另一个终端）
bytomcli net-info
bytomcli get-block-count
```

**场景：后续启动节点**

```bash
# 直接启动即可（不需要再 init）
bytomd node
```

---

## 3.5 命令行参数解析

### 3.5.1 参数解析机制

比原链使用 **Go 标准库的 flag 包**和 **Cobra 框架**来解析命令行参数。

**查看帮助信息：**
```bash
bytomd -h
# 或
bytomd --help
```

### 3.5.2 命令结构

**`bytomd` 顶层命令下有 4 个子命令：**

| 子命令 | 功能 | 使用频率 |
|--------|------|----------|
| `help` | 显示帮助信息 | 查询时使用 |
| `init` | 初始化网络类型 | **第一次运行前执行一次** |
| `node` | 运行 bytomd 节点 | **每次启动都要执行** |
| `version` | 显示版本信息 | 查询时使用 |

### 3.5.3 全局参数（Global Flags）

**全局参数在所有子命令中都可以使用：**

| 参数 | 说明 | 示例 |
|------|------|------|
| `--home string` | 指定 bytomd 运行的 home 目录，存储配置、keystore、数据的目录 | `bytomd --home /path/to/data node` |
| `--trace` | 启用 trace 功能，出错时显示出错栈信息 | `bytomd --trace node` |

### 3.5.4 主要命令详解

#### 1. init 命令（初始化）

**功能**：初始化区块链配置文件（**只需要执行一次**）

**用法：**
```bash
bytomd init --chain_id [mainnet|testnet|solonet]
```

**主要参数：**

| 参数 | 说明 | 可选值 |
|------|------|--------|
| `--chain_id` | 指定初始化的网络类型 | `mainnet` / `testnet` / `solonet` |

**作用：**
- 生成 `config.toml` 配置文件
- 生成节点私钥文件
- 创建数据目录结构

#### 2. node 命令（启动守护进程）

**功能**：运行 bytomd 节点（**每次启动都要执行**）

**用法：**
```bash
bytomd node [flags]
```

**重要：以下参数都是 `bytomd node` 子命令的专属 Flags，只有在执行 `bytomd node` 时才生效。**

**核心功能开关：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--chain_id` | 选择网络类型（mainnet/testnet/solonet） | solonet |
| `--mining` | 开启挖矿模式 | false |
| `--wallet.disable` | 关闭本地钱包功能 | false |
| `--web.closed` | 关闭 Web Dashboard | false |
| `--vault_mode` | 运行无网络的 Vault 模式 | false |
| `--auth.disable` | 禁用 RPC 访问认证 | false |

**P2P 网络配置：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--p2p.laddr` | P2P 监听地址 | tcp://0.0.0.0:46658 |
| `--p2p.seeds` | 种子节点地址（逗号分隔） | 空 |
| `--p2p.max_num_peers` | 最大连接节点数 | 50 |
| `--p2p.handshake_timeout` | 握手超时时间（秒） | 30 |
| `--p2p.dial_timeout` | 连接超时时间（秒） | 3 |
| `--p2p.lan_discoverable` | 是否可被局域网发现 | true |
| `--p2p.skip_upnp` | 跳过 UPNP 配置 | false |
| `--p2p.proxy_address` | SOCKS5 代理地址 | 空 |
| `--p2p.proxy_username` | 代理用户名 | 空 |
| `--p2p.proxy_password` | 代理密码 | 空 |
| `--p2p.keep_dial` | 保持连接的节点地址 | 空 |

**钱包配置：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--wallet.rescan` | 重新扫描钱包 | false |
| `--wallet.txindex` | 保存全局交易索引 | false |

**日志和调试：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--log_level` | 日志级别（debug/info/warn/error/fatal） | info |
| `--log_file` | 日志输出文件 | log |
| `--prof_laddr` | 启用 pprof 调试模式（HTTP 地址） | 空 |
| `--trace` | 启用详细错误栈追踪 | false |

**WebSocket 配置：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--ws.max_num_websockets` | 最大 WebSocket 连接数 | 25 |
| `--ws.max_num_concurrent_reqs` | 最大并发请求数 | 20 |

**使用示例：**
```bash
# 基本启动
bytomd node

# 启动并开启挖矿
bytomd node --mining

# 启动并指定种子节点
bytomd node --p2p.seeds "seed1.bytom.io:46658,seed2.bytom.io:46658"

# 启动并关闭 Web 界面
bytomd node --web.closed

# 启动并启用调试模式
bytomd node --prof_laddr "localhost:6060" --log_level debug
```

#### 3. version 命令（版本信息）

**功能**：显示版本信息

**用法：**
```bash
bytomd version
```

**参数：** 无额外参数，直接执行即可

#### 4. help 命令（帮助信息）

**功能**：显示帮助信息

**用法：**
```bash
# 查看主帮助
bytomd help

# 查看子命令帮助
bytomd help node
bytomd help init
```

### 3.5.5 参数归属总结

**参数分类：**

1. **全局参数**（所有子命令可用）：
   - `--home` - 指定数据目录
   - `--trace` - 启用错误追踪

2. **node 子命令专属参数**（只在 `bytomd node` 时生效）：
   - 所有 `--p2p.*` 参数（P2P 网络配置）
   - 所有 `--wallet.*` 参数（钱包配置）
   - `--mining`、`--web.closed`、`--auth.disable` 等（功能开关）
   - `--log_level`、`--log_file`、`--prof_laddr`（日志和调试）

3. **init 子命令专属参数**：
   - `--chain_id` - 指定网络类型

4. **version 和 help 命令**：
   - 无额外参数

---

**返回**: [bytomd 守护进程详解](./bytomd守护进程详解.md)

