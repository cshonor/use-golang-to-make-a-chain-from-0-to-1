# 启动和命令详解

> 第三章子文档：bytomd 的启动流程和命令行参数详解

---

## 3.4 启动流程：init 和 node 命令的关系

### 3.4.1 两个核心命令的分工

**重要理解：`init` 和 `node` 是先后顺序，不是并列关系**

| 命令 | 作用 | 执行时机 |
|------|------|----------|
| `bytomd init` | 初始化节点环境，创建配置文件、数据目录、生成节点密钥等 | **第一次运行节点前，只需要执行一次** |
| `bytomd node` | 启动守护进程，加载配置、初始化所有模块并进入运行状态 | **每次启动节点都要执行** |

### 3.4.2 完整的启动流程

#### 第一步：初始化（init）

**命令：**
```bash
# 初始化主网节点（也可以用 testnet / solonet）
bytomd init --chain_id mainnet
```

**作用：**
- 生成 `config.toml` 配置文件
- 创建数据目录（存储区块、钱包、密钥）
- 生成节点公私钥对
- 创建目录结构

**重要：**
- ✅ 这一步**只需要做一次**
- ✅ 之后如果不换网络/重装，就不用再执行了
- ✅ 如果配置文件已存在，会提示 "Already exists config file."

**代码实现：**
```go
func initFiles(cmd *cobra.Command, args []string) {
    configFilePath := path.Join(config.RootDir, "config.toml")
    
    // 检查配置文件是否已存在
    if _, err := os.Stat(configFilePath); !os.IsNotExist(err) {
        log.Info("Already exists config file.")
        return
    }
    
    // 根据 chain_id 创建配置文件
    switch config.ChainID {
    case "mainnet", "testnet":
        cfg.EnsureRoot(config.RootDir, config.ChainID)
    default:
        cfg.EnsureRoot(config.RootDir, "solonet")
    }
    
    // 生成节点私钥
    xprv, err := chainkd.NewXPrv(nil)
    // 保存私钥文件
}
```

#### 第二步：启动守护进程（node）

**命令：**
```bash
# 启动节点，开启挖矿和 Web 面板
bytomd node --mining --web.closed=false
```

**作用：**
- 加载 `init` 生成的配置和数据
- 初始化 Node 对象里的所有模块（钱包、同步管理器、API、挖矿等）
- 启动 P2P 网络、同步区块、开启 API 服务
- 进入守护循环，持续运行

**代码实现：**
```go
func runNode(cmd *cobra.Command, args []string) error {
    setLogLevel(config.LogLevel)
    
    // 创建节点对象（初始化所有模块）
    n := node.NewNode(config)
    
    // 启动节点（调用 Node.Start()）
    if err := n.Start(); err != nil {
        log.Fatal("failed to start node")
    }
    
    // 持续运行（进入守护循环）
    n.RunForever()
    return nil
}
```

### 3.4.3 Node.Start() 方法的作用

**重要理解：**

- ❌ **不是**先 `start` 再 `init`，而是先 `init` 再 `node`
- ❌ `init` **不是**每次启动都要做，只做一次
- ✅ `node` 才是每次启动节点都要执行的命令

**Node.Start() 执行顺序：**

```go
func (n *Node) OnStart() error {
    // 1. 启动 API 服务器（这是唯一对外的入口）
    n.api.StartServer(*listenAddr)
    
    // 2. 启动区块提议者（如果启用挖矿）
    if n.miningEnable {
        n.blockProposer.Start()
    }
    
    // 3. 启动网络同步管理器（P2P 网络）
    if err := n.syncManager.Start(); err != nil {
        return err
    }
    
    // 4. 启动 WebSocket 通知管理器
    if err := n.notificationMgr.Start(); err != nil {
        return err
    }
    
    return nil
}
```

**启动后的状态：**
- ✅ API Service 监听 `http://localhost:9888`
- ✅ P2P 网络开始连接其他节点
- ✅ 区块同步开始
- ✅ 如果启用挖矿，开始挖矿
- ✅ 等待 CLI 或 Web 界面的请求

### 3.4.4 常见误区澄清

| 误区 | 正确理解 |
|------|---------|
| ❌ 先 start 再 init | ✅ 先 init 再 node |
| ❌ init 每次启动都要做 | ✅ init 只做一次 |
| ❌ node 命令就是 start | ✅ node 命令内部调用 Node.Start() |
| ❌ CLI 直接连接数据库 | ✅ CLI 通过 API Service 访问 |
| ❌ CLI 直接连接 P2P | ✅ CLI 通过 API Service 访问 |

### 3.4.5 完整启动示例

**场景：第一次启动比原链节点**

```bash
# 步骤 1：初始化（只需要执行一次）
bytomd init --chain_id solonet

# 步骤 2：启动节点（每次启动都要执行）
bytomd node

# 步骤 3：验证节点运行（使用另一个终端）
bytomcli net-info
bytomcli get-block-count
```

**场景：后续启动节点**

```bash
# 直接启动即可（不需要再 init）
bytomd node
```

---

## 3.5 命令行参数解析

### 3.5.1 参数解析机制

比原链使用 **Go 标准库的 flag 包**和 **Cobra 框架**来解析命令行参数。

**查看帮助信息：**
```bash
bytomd -h
# 或
bytomd --help
```

### 3.5.2 命令结构

**`bytomd` 顶层命令下有 4 个子命令：**

| 子命令 | 功能 | 使用频率 |
|--------|------|----------|
| `help` | 显示帮助信息 | 查询时使用 |
| `init` | 初始化网络类型 | **第一次运行前执行一次** |
| `node` | 运行 bytomd 节点 | **每次启动都要执行** |
| `version` | 显示版本信息 | 查询时使用 |

### 3.5.3 全局参数（Global Flags）

**全局参数在所有子命令中都可以使用：**

| 参数 | 说明 | 示例 |
|------|------|------|
| `--home string` | 指定 bytomd 运行的 home 目录，存储配置、keystore、数据的目录 | `bytomd --home /path/to/data node` |
| `--trace` | 启用 trace 功能，出错时显示出错栈信息 | `bytomd --trace node` |

### 3.5.4 主要命令详解

#### 1. init 命令（初始化）

**功能**：初始化区块链配置文件（**只需要执行一次**）

**用法：**
```bash
bytomd init --chain_id [mainnet|testnet|solonet]
```

**主要参数：**

| 参数 | 说明 | 可选值 |
|------|------|--------|
| `--chain_id` | 指定初始化的网络类型 | `mainnet` / `testnet` / `solonet` |

**作用：**
- 生成 `config.toml` 配置文件
- 生成节点私钥文件
- 创建数据目录结构

#### 2. node 命令（启动守护进程）

**功能**：运行 bytomd 节点（**每次启动都要执行**）

**用法：**
```bash
bytomd node [flags]
```

**重要：以下参数都是 `bytomd node` 子命令的专属 Flags，只有在执行 `bytomd node` 时才生效。**

**核心功能开关：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--chain_id` | 选择网络类型（mainnet/testnet/solonet） | solonet |
| `--mining` | 开启挖矿模式 | false |
| `--wallet.disable` | 关闭本地钱包功能 | false |
| `--web.closed` | 关闭 Web Dashboard | false |
| `--vault_mode` | 运行无网络的 Vault 模式 | false |
| `--auth.disable` | 禁用 RPC 访问认证 | false |

**P2P 网络配置：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--p2p.laddr` | P2P 监听地址 | tcp://0.0.0.0:46658 |
| `--p2p.seeds` | 种子节点地址（逗号分隔） | 空 |
| `--p2p.max_num_peers` | 最大连接节点数 | 50 |
| `--p2p.handshake_timeout` | 握手超时时间（秒） | 30 |
| `--p2p.dial_timeout` | 连接超时时间（秒） | 3 |
| `--p2p.lan_discoverable` | 是否可被局域网发现 | true |
| `--p2p.skip_upnp` | 跳过 UPNP 配置 | false |
| `--p2p.proxy_address` | SOCKS5 代理地址 | 空 |
| `--p2p.proxy_username` | 代理用户名 | 空 |
| `--p2p.proxy_password` | 代理密码 | 空 |
| `--p2p.keep_dial` | 保持连接的节点地址 | 空 |

**钱包配置：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--wallet.rescan` | 重新扫描钱包 | false |
| `--wallet.txindex` | 保存全局交易索引 | false |

**日志和调试：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--log_level` | 日志级别（debug/info/warn/error/fatal） | info |
| `--log_file` | 日志输出文件 | log |
| `--prof_laddr` | 启用 pprof 调试模式（HTTP 地址） | 空 |
| `--trace` | 启用详细错误栈追踪 | false |

**WebSocket 配置：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--ws.max_num_websockets` | 最大 WebSocket 连接数 | 25 |
| `--ws.max_num_concurrent_reqs` | 最大并发请求数 | 20 |

**使用示例：**
```bash
# 基本启动
bytomd node

# 启动并开启挖矿
bytomd node --mining

# 启动并指定种子节点
bytomd node --p2p.seeds "seed1.bytom.io:46658,seed2.bytom.io:46658"

# 启动并关闭 Web 界面
bytomd node --web.closed

# 启动并启用调试模式
bytomd node --prof_laddr "localhost:6060" --log_level debug
```

#### 3. version 命令（版本信息）

**功能**：显示版本信息

**用法：**
```bash
bytomd version
```

**参数：** 无额外参数，直接执行即可

#### 4. help 命令（帮助信息）

**功能**：显示帮助信息

**用法：**
```bash
# 查看主帮助
bytomd help

# 查看子命令帮助
bytomd help node
bytomd help init
```

### 3.5.5 参数归属总结

**参数分类：**

1. **全局参数**（所有子命令可用）：
   - `--home` - 指定数据目录
   - `--trace` - 启用错误追踪

2. **node 子命令专属参数**（只在 `bytomd node` 时生效）：
   - 所有 `--p2p.*` 参数（P2P 网络配置）
   - 所有 `--wallet.*` 参数（钱包配置）
   - `--mining`、`--web.closed`、`--auth.disable` 等（功能开关）
   - `--log_level`、`--log_file`、`--prof_laddr`（日志和调试）

3. **init 子命令专属参数**：
   - `--chain_id` - 指定网络类型

4. **version 和 help 命令**：
   - 无额外参数

---

**返回**: [bytomd 守护进程详解](./bytomd守护进程详解.md)

