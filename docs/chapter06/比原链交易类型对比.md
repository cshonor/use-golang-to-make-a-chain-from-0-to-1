# 比原链交易类型对比：Coinbase交易 vs 普通交易

> 比原链（Bytom）两种交易类型的详细对比与数据结构分析

---

## 概述

比原链支持两种核心交易类型：**Coinbase交易（币基交易）**和**普通交易（用户交易）**。这两种交易在数据结构、发起方式、验证机制等方面存在本质区别。

---

## 一、Coinbase交易（币基交易）

### 核心特征

- **唯一发起方**：出块节点/矿工
- **位置**：每个区块的**第一笔交易**
- **作用**：发放区块奖励 + 收取交易手续费
- **特点**：**没有输入来源**，直接铸新币

### 数据结构（Go语言）

```go
// Coinbase交易的Input结构
type CoinbaseInput struct {
    Arbitrary []byte  // 任意数据（通常包含区块高度等信息）
}

// 完整的Coinbase交易示例
coinbaseTx := &Tx{
    Version: 1,
    Inputs: []*TxInput{
        {
            AssetVersion: 1,
            TypedInput: &CoinbaseInput{
                Arbitrary: []byte("block_height_12345"),  // 区块高度等任意信息
            },
        },
    },
    Outputs: []*TxOutput{
        {
            Amount: 41250000000,  // 区块奖励 + 手续费
            AssetID: BTMAssetID,  // BTM资产ID
            ControlProgram: minerAddress,  // 矿工地址
        },
    },
}
```

### 关键字段说明

- `Arbitrary`: 任意字节数组，通常包含区块高度、时间戳等信息
- **没有** `SourceID`、`SourcePosition`（因为没有输入来源）
- **没有** `Arguments`（不需要签名验证）
- `AssetID()` 返回空值（不关联任何资产输入）

### 工作原理

1. **矿工打包区块时**，自动创建Coinbase交易
2. **计算总奖励** = 区块奖励 + 本区块所有交易的手续费
3. **将奖励发送给矿工地址**，作为挖矿激励
4. **无需验证输入**，因为这是系统直接发行的新币

---

## 二、普通交易（用户交易）

### 核心特征

- **发起方**：普通用户/钱包
- **作用**：转移已有资产（BTM、资产通证等）
- **特点**：有明确的输入（来源UTXO）和输出（目标地址）

### 数据结构（Go语言）

```go
// 普通交易的Input结构（SpendInput）
type SpendInput struct {
    SpendCommitment
    Arguments [][]byte  // 见证数据（签名等）
}

// SpendCommitment包含的字段
type SpendCommitment struct {
    AssetAmount        // 资产ID和金额
    SourceID       bc.Hash    // 引用的交易ID
    SourcePosition uint64     // 引用的输出索引
    VMVersion      uint64     // 虚拟机版本
    ControlProgram []byte     // 控制脚本（地址）
    StateData      [][]byte   // 状态数据
}

// 完整的普通交易示例
normalTx := &Tx{
    Version: 1,
    Inputs: []*TxInput{
        {
            AssetVersion: 1,
            TypedInput: &SpendInput{
                SpendCommitment: SpendCommitment{
                    AssetAmount: bc.AssetAmount{
                        AssetId: &btmAssetID,
                        Amount:  1500000000,  // 1.5 BTM
                    },
                    SourceID:       previousTxHash,  // 引用的交易哈希
                    SourcePosition: 0,              // 引用的输出索引
                    VMVersion:      1,
                    ControlProgram: senderAddress,   // 发送者地址
                },
                Arguments: [][]byte{signature},  // 签名数据
            },
        },
    },
    Outputs: []*TxOutput{
        {
            Amount: 1000000000,  // 1.0 BTM 给收款人
            AssetID: btmAssetID,
            ControlProgram: receiverAddress,
        },
        {
            Amount: 499000000,   // 0.499 BTM 找零（1.5 - 1.0 - 0.001手续费）
            AssetID: btmAssetID,
            ControlProgram: senderAddress,
        },
    },
}
```

### 关键字段说明

- `SourceID`: 引用的前一笔交易的哈希
- `SourcePosition`: 引用的输出在交易中的索引位置
- `AssetAmount`: 包含资产ID和金额
- `ControlProgram`: 控制脚本（地址），用于验证所有权
- `Arguments`: 见证数据（签名），用于证明有权花费该UTXO

### 实际JSON结构示例

**区块浏览器显示的简化视图：**
```
从 bm1q5wtajhqBvxvu3pedct23qcvqqww44wa 转账：
- 31798 BTM → bmiqvenshuudsjhqysxak5yeudp5evmetly9zna69
- 9999.995 BTM → bm1qvr68qcfjw6lu7euqfr9gky6g9rxgjegrsjkd8d
- 1798 BTM → ...
手续费：0.005 BTM
```

**底层实际的JSON数据结构：**
```json
{
  "id": "7d769fb564e5dc4947dab944c33e1b3ec522b8celebdaf365d00edf576fbe7c1",
  "version": 1,
  "size": 464,
  "time_range": 0,
  "status_fail": false,
  "inputs": [
    {
      "type": "spend",
      "asset_id": "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
      "asset_definition": [],
      "amount": 3179800000000,
      "address": "bm1q5wtajhqBvxvu3pedct23qcvqqww44wa",
      "control_program": "00148397d2cae03019667221cb70b514186010076876",
      "input_id": "cb299ef868d4f7de93c2dfb23b955283fc769179636f4dcfab344976056287",
      "spent_output_id": "be08e806d5fa7ba234a586fb8ed68a94c0ff79f657a1c9064db124336acbfa55",
      "witness_arguments": [
        "01a1b2c3d4e5f6...",
        "02f6e5d4c3b2a1..."
      ],
      "mux_id": "999556543fb339227585279b2b1c3a17a05bd624aa68feedda2092026280858"
    }
  ],
  "outputs": [
    {
      "type": "control",
      "id": "058c30247fa93cc30690799aa5a34f11df94m27562045094c4fd2d896125",
      "position": 0,
      "asset_id": "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
      "asset_definition": {},
      "amount": 999999500000,
      "address": "bmiqvens3huudsjhqyaxak5yeudp5evmetlyzna65",
      "control_program": "0014666708df9c6c25701206eda04cflala659bcafe4"
    },
    {
      "type": "control",
      "id": "...",
      "position": 1,
      "asset_id": "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
      "asset_definition": {},
      "amount": 179800000000,
      "address": "belqvz68qcfjw6lu7euqfz3gky6gragjograjkded",
      "control_program": "0014..."
    },
    {
      "type": "control",
      "id": "...",
      "position": 2,
      "asset_id": "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
      "asset_definition": {},
      "amount": 1000000000000,
      "address": "bm1q3e4te09805zd6wkx3k455kz4dgade5y7fxtdc",
      "control_program": "0014..."
    },
    {
      "type": "control",
      "id": "058c30247fa93cc30690799aa5a34f11df94m27562045094c4fd2d896125",
      "position": 3,
      "asset_id": "0000000000000000000000000000000000000000000000000000000000000002",
      "asset_definition": {},
      "amount": 1000000000000,
      "address": "bm1q...",
      "control_program": "00148a46c4cd3ff5fc5b98164d2d0d58a12265cb3"
    }
  ]
}
```

**关键字段解析：**

**Input字段：**
- `type: "spend"` - 标识这是普通交易（spend类型），与Coinbase交易的`type: "coinbase"`不同
- `spent_output_id` - 被花费的UTXO的ID（对应Go代码中的`SourceID`）
- `witness_arguments` - 见证数据数组，包含签名等验证信息（对应Go代码中的`Arguments`）
- `mux_id` - 多路复用ID，用于关联输入输出
- `control_program` - 控制脚本，用于验证UTXO所有权

**Output字段：**
- `type: "control"` - 控制类型输出
- `position` - 输出在交易中的索引位置
- `asset_id` - 资产ID（`ffff...ffff`表示BTM原生资产）
- `amount` - 输出金额（最小单位，需要除以10^8得到BTM数量）

**交易元数据：**
- `id` - 交易唯一标识符
- `version` - 交易版本号
- `size` - 交易大小（字节）
- `status_fail` - 交易状态（false表示成功）

### 工作原理

1. **用户选择要花费的UTXO**（之前收到的交易输出）
2. **构造交易输入**，引用该UTXO（`SourceID` + `SourcePosition`）
3. **使用私钥签名**，证明拥有该UTXO的所有权
4. **创建交易输出**，包括：
   - 给收款人的输出
   - 找零给自己的输出
5. **手续费** = 输入总额 - 输出总额

---

## 三、数据结构对比表

| 维度 | Coinbase交易 | 普通交易（SpendInput） |
|------|------------|---------------------|
| **Input类型** | `CoinbaseInput` | `SpendInput` |
| **输入来源** | ❌ **无**（`Arbitrary`字段仅存储元数据） | ✅ **有**（`SourceID` + `SourcePosition`） |
| **资产来源** | ❌ **无**（直接铸币） | ✅ **有**（引用已有UTXO） |
| **签名验证** | ❌ **不需要**（`Arguments`为空） | ✅ **需要**（`Arguments`包含签名） |
| **AssetID** | 返回空值 | 返回引用的资产ID |
| **金额来源** | 区块奖励 + 手续费 | 来自引用的UTXO |
| **发起者** | 矿工/出块节点 | 普通用户/钱包 |
| **位置** | 区块第一笔交易 | 区块中任意位置 |
| **成熟期** | 需要等待 `CoinbasePendingBlockNumber` 个区块 | 立即可用 |
| **验证方式** | 无需验证输入 | 需要验证UTXO存在性和签名有效性 |

---

## 四、区块浏览器视图 vs 底层数据结构

### 重要区别说明

**区块浏览器为了用户友好，会简化显示交易信息：**
- 只显示地址、金额、手续费等关键信息
- 隐藏了底层的数据结构细节
- 将复杂的UTXO引用简化为"从A地址到B地址"

**但底层实际的JSON数据结构要复杂得多：**
- 包含完整的输入输出引用关系
- 包含签名数据（`witness_arguments`）
- 包含控制脚本（`control_program`）
- 包含资产定义、位置索引等详细信息

### 示例对比

**区块浏览器显示：**
```
交易 #105449
从: bm1q5wtajhqBvxvu3pedct23qcvqqww44wa
到: 
  - bmiqvenshuudsjhqysxak5yeudp5evmetly9zna69 (31798 BTM)
  - bm1qvr68qcfjw6lu7euqfr9gky6g9rxgjegrsjkd8d (9999.995 BTM)
  - ... (1798 BTM)
手续费: 0.005 BTM
```

**底层JSON结构（见上方"实际JSON结构示例"）：**
- 需要引用具体的UTXO（`spent_output_id`）
- 需要提供签名证明（`witness_arguments`）
- 需要指定每个输出的位置（`position`）
- 包含完整的资产ID和控制脚本

### 为什么会有这种差异？

1. **用户体验**：普通用户不需要看到技术细节
2. **安全性**：签名数据通常不在浏览器中完整显示
3. **性能**：简化视图加载更快
4. **可读性**：地址和金额比哈希值更易理解

**开发者需要注意：**
- 实际开发时需要处理完整的JSON结构
- 需要理解UTXO的引用关系
- 需要正确处理签名和验证逻辑

---

## 五、在区块浏览器中如何识别

### 识别Coinbase交易

1. **查看交易的 `Inputs` 数组**
2. **检查Input类型**：如果 `Inputs[0].InputType() == CoinbaseInputType`，则为Coinbase交易
3. **查看Arbitrary字段**：通常 `Inputs[0]` 的 `Arbitrary` 字段包含区块高度信息
4. **交易位置**：通常是区块中的第一笔交易（索引为0）
5. **交易ID特征**：交易ID可能以特定前缀开头（取决于实现）

### 识别普通交易

1. **查看交易的 `Inputs` 数组**
2. **检查Input类型**：如果 `Inputs[0].InputType() == SpendInputType`，则为普通交易
3. **查看输入引用**：`Inputs` 中的每个输入都有 `SourceID` 和 `SourcePosition`
4. **查看签名数据**：有 `Arguments` 字段（包含签名数据）
5. **交易位置**：可以在区块中的任意位置（除了第一笔）

---

## 六、实际应用场景

### Coinbase交易场景

```go
// 矿工打包区块时创建Coinbase交易
func CreateCoinbaseTx(minerAddress []byte, blockHeight uint64, totalFee uint64) *Tx {
    blockReward := CalculateBlockReward(blockHeight)  // 计算区块奖励
    totalAmount := blockReward + totalFee              // 奖励 + 手续费
    
    return &Tx{
        Version: 1,
        Inputs: []*TxInput{
            NewCoinbaseInput([]byte(fmt.Sprintf("height_%d", blockHeight))),
        },
        Outputs: []*TxOutput{
            NewOriginalTxOutput(BTMAssetID, totalAmount, minerAddress, nil),
        },
    }
}
```

**使用场景：**
- 矿工成功挖出新区块时
- 系统自动创建，无需用户操作
- 奖励金额 = 固定区块奖励 + 本区块所有交易手续费

### 普通交易场景

```go
// 用户转账时创建普通交易
func CreateTransferTx(
    fromUTXO *UTXO,      // 要花费的UTXO
    toAddress []byte,    // 收款地址
    amount uint64,       // 转账金额
    privateKey []byte,   // 私钥（用于签名）
) *Tx {
    // 计算找零
    fee := uint64(1000000)  // 假设手续费为 0.001 BTM
    change := fromUTXO.Amount - amount - fee
    
    // 创建签名
    signature := Sign(fromUTXO, privateKey)
    
    return &Tx{
        Version: 1,
        Inputs: []*TxInput{
            NewSpendInput(
                [][]byte{signature},           // Arguments
                fromUTXO.TxHash,               // SourceID
                fromUTXO.AssetID,              // AssetID
                fromUTXO.Amount,               // Amount
                fromUTXO.OutputIndex,          // SourcePosition
                fromUTXO.ControlProgram,       // ControlProgram
                nil,                           // StateData
            ),
        },
        Outputs: []*TxOutput{
            NewOriginalTxOutput(fromUTXO.AssetID, amount, toAddress, nil),
            NewOriginalTxOutput(fromUTXO.AssetID, change, fromUTXO.Address, nil),
        },
    }
}
```

**使用场景：**
- 用户之间转账BTM或其他资产
- 钱包应用创建交易
- 需要用户签名授权
- 需要支付手续费

---

## 七、核心区别总结

### 1. 输入来源

- **Coinbase交易**：无输入来源，`Arbitrary`字段仅用于存储元数据
- **普通交易**：必须引用已有的UTXO（通过`SourceID`和`SourcePosition`）

### 2. 资产来源

- **Coinbase交易**：直接铸新币，无资产来源
- **普通交易**：从已有UTXO中转移资产

### 3. 验证机制

- **Coinbase交易**：无需签名验证，系统自动验证
- **普通交易**：需要提供签名（`Arguments`），验证UTXO所有权

### 4. 发起权限

- **Coinbase交易**：只有矿工/出块节点可以创建
- **普通交易**：任何用户都可以创建

### 5. 成熟期限制

- **Coinbase交易**：需要等待`CoinbasePendingBlockNumber`个区块后才能花费（防止51%攻击）
- **普通交易**：一旦确认立即可用

---

## 八、与比特币/币安链的对比

比原链的交易类型设计与比特币、币安链逻辑一致：

| 特性 | 比特币 | 币安链 | 比原链 |
|------|--------|--------|--------|
| Coinbase交易 | ✅ 有 | ✅ 有 | ✅ 有 |
| 普通交易 | ✅ 有 | ✅ 有 | ✅ 有 |
| UTXO模型 | ✅ 是 | ✅ 是 | ✅ 是 |
| 交易结构 | Inputs + Outputs | Inputs + Outputs | Inputs + Outputs |

**主要区别在于：**
- 比原链支持多种资产类型（不仅限于BTM）
- 比原链的脚本系统（VM）更灵活
- 比原链的Coinbase交易包含`Arbitrary`字段，可存储更多元数据

---

## 相关资源

- [UTXO模型详解](./UTXO模型详解.md)
- [比原链技术文档](https://github.com/Bytom/bytom)
- [比特币白皮书](https://bitcoin.org/bitcoin.pdf)

---

**返回**: [第六章目录](./README.md)

