# 比原链交易类型对比：Coinbase交易 vs 普通交易

> 比原链（Bytom）两种交易类型的详细对比与数据结构分析

---

## 概述

比原链支持两种核心交易类型：**Coinbase交易（币基交易）**和**普通交易（用户交易）**。这两种交易在数据结构、发起方式、验证机制等方面存在本质区别。

---

## 一、Coinbase交易（币基交易）

### 核心特征

- **唯一发起方**：出块节点/矿工
- **位置**：每个区块的**第一笔交易**
- **作用**：发放区块奖励 + 收取交易手续费
- **特点**：**没有输入来源**，直接铸新币

### 数据结构（Go语言）

```go
// Coinbase交易的Input结构
type CoinbaseInput struct {
    Arbitrary []byte  // 任意数据（通常包含区块高度等信息）
}

// 完整的Coinbase交易示例
coinbaseTx := &Tx{
    Version: 1,
    Inputs: []*TxInput{
        {
            AssetVersion: 1,
            TypedInput: &CoinbaseInput{
                Arbitrary: []byte("block_height_12345"),  // 区块高度等任意信息
            },
        },
    },
    Outputs: []*TxOutput{
        {
            Amount: 41250000000,  // 区块奖励 + 手续费
            AssetID: BTMAssetID,  // BTM资产ID
            ControlProgram: minerAddress,  // 矿工地址
        },
    },
}
```

### 关键字段说明

- `Arbitrary`: 任意字节数组，通常包含区块高度、时间戳等信息
- **没有** `SourceID`、`SourcePosition`（因为没有输入来源）
- **没有** `Arguments`（不需要签名验证）
- `AssetID()` 返回空值（不关联任何资产输入）

### 工作原理

1. **矿工打包区块时**，自动创建Coinbase交易
2. **计算总奖励** = 区块奖励 + 本区块所有交易的手续费
3. **将奖励发送给矿工地址**，作为挖矿激励
4. **无需验证输入**，因为这是系统直接发行的新币

---

## 二、普通交易（用户交易）

### 核心特征

- **发起方**：普通用户/钱包
- **作用**：转移已有资产（BTM、资产通证等）
- **特点**：有明确的输入（来源UTXO）和输出（目标地址）

### 数据结构（Go语言）

```go
// 普通交易的Input结构（SpendInput）
type SpendInput struct {
    SpendCommitment
    Arguments [][]byte  // 见证数据（签名等）
}

// SpendCommitment包含的字段
type SpendCommitment struct {
    AssetAmount        // 资产ID和金额
    SourceID       bc.Hash    // 引用的交易ID
    SourcePosition uint64     // 引用的输出索引
    VMVersion      uint64     // 虚拟机版本
    ControlProgram []byte     // 控制脚本（地址）
    StateData      [][]byte   // 状态数据
}

// 完整的普通交易示例
normalTx := &Tx{
    Version: 1,
    Inputs: []*TxInput{
        {
            AssetVersion: 1,
            TypedInput: &SpendInput{
                SpendCommitment: SpendCommitment{
                    AssetAmount: bc.AssetAmount{
                        AssetId: &btmAssetID,
                        Amount:  1500000000,  // 1.5 BTM
                    },
                    SourceID:       previousTxHash,  // 引用的交易哈希
                    SourcePosition: 0,              // 引用的输出索引
                    VMVersion:      1,
                    ControlProgram: senderAddress,   // 发送者地址
                },
                Arguments: [][]byte{signature},  // 签名数据
            },
        },
    },
    Outputs: []*TxOutput{
        {
            Amount: 1000000000,  // 1.0 BTM 给收款人
            AssetID: btmAssetID,
            ControlProgram: receiverAddress,
        },
        {
            Amount: 499000000,   // 0.499 BTM 找零（1.5 - 1.0 - 0.001手续费）
            AssetID: btmAssetID,
            ControlProgram: senderAddress,
        },
    },
}
```

### 关键字段说明

- `SourceID`: 引用的前一笔交易的哈希
- `SourcePosition`: 引用的输出在交易中的索引位置
- `AssetAmount`: 包含资产ID和金额
- `ControlProgram`: 控制脚本（地址），用于验证所有权
- `Arguments`: 见证数据（签名），用于证明有权花费该UTXO

### 工作原理

1. **用户选择要花费的UTXO**（之前收到的交易输出）
2. **构造交易输入**，引用该UTXO（`SourceID` + `SourcePosition`）
3. **使用私钥签名**，证明拥有该UTXO的所有权
4. **创建交易输出**，包括：
   - 给收款人的输出
   - 找零给自己的输出
5. **手续费** = 输入总额 - 输出总额

---

## 三、数据结构对比表

| 维度 | Coinbase交易 | 普通交易（SpendInput） |
|------|------------|---------------------|
| **Input类型** | `CoinbaseInput` | `SpendInput` |
| **输入来源** | ❌ **无**（`Arbitrary`字段仅存储元数据） | ✅ **有**（`SourceID` + `SourcePosition`） |
| **资产来源** | ❌ **无**（直接铸币） | ✅ **有**（引用已有UTXO） |
| **签名验证** | ❌ **不需要**（`Arguments`为空） | ✅ **需要**（`Arguments`包含签名） |
| **AssetID** | 返回空值 | 返回引用的资产ID |
| **金额来源** | 区块奖励 + 手续费 | 来自引用的UTXO |
| **发起者** | 矿工/出块节点 | 普通用户/钱包 |
| **位置** | 区块第一笔交易 | 区块中任意位置 |
| **成熟期** | 需要等待 `CoinbasePendingBlockNumber` 个区块 | 立即可用 |
| **验证方式** | 无需验证输入 | 需要验证UTXO存在性和签名有效性 |

---

## 四、在区块浏览器中如何识别

### 识别Coinbase交易

1. **查看交易的 `Inputs` 数组**
2. **检查Input类型**：如果 `Inputs[0].InputType() == CoinbaseInputType`，则为Coinbase交易
3. **查看Arbitrary字段**：通常 `Inputs[0]` 的 `Arbitrary` 字段包含区块高度信息
4. **交易位置**：通常是区块中的第一笔交易（索引为0）
5. **交易ID特征**：交易ID可能以特定前缀开头（取决于实现）

### 识别普通交易

1. **查看交易的 `Inputs` 数组**
2. **检查Input类型**：如果 `Inputs[0].InputType() == SpendInputType`，则为普通交易
3. **查看输入引用**：`Inputs` 中的每个输入都有 `SourceID` 和 `SourcePosition`
4. **查看签名数据**：有 `Arguments` 字段（包含签名数据）
5. **交易位置**：可以在区块中的任意位置（除了第一笔）

---

## 五、实际应用场景

### Coinbase交易场景

```go
// 矿工打包区块时创建Coinbase交易
func CreateCoinbaseTx(minerAddress []byte, blockHeight uint64, totalFee uint64) *Tx {
    blockReward := CalculateBlockReward(blockHeight)  // 计算区块奖励
    totalAmount := blockReward + totalFee              // 奖励 + 手续费
    
    return &Tx{
        Version: 1,
        Inputs: []*TxInput{
            NewCoinbaseInput([]byte(fmt.Sprintf("height_%d", blockHeight))),
        },
        Outputs: []*TxOutput{
            NewOriginalTxOutput(BTMAssetID, totalAmount, minerAddress, nil),
        },
    }
}
```

**使用场景：**
- 矿工成功挖出新区块时
- 系统自动创建，无需用户操作
- 奖励金额 = 固定区块奖励 + 本区块所有交易手续费

### 普通交易场景

```go
// 用户转账时创建普通交易
func CreateTransferTx(
    fromUTXO *UTXO,      // 要花费的UTXO
    toAddress []byte,    // 收款地址
    amount uint64,       // 转账金额
    privateKey []byte,   // 私钥（用于签名）
) *Tx {
    // 计算找零
    fee := uint64(1000000)  // 假设手续费为 0.001 BTM
    change := fromUTXO.Amount - amount - fee
    
    // 创建签名
    signature := Sign(fromUTXO, privateKey)
    
    return &Tx{
        Version: 1,
        Inputs: []*TxInput{
            NewSpendInput(
                [][]byte{signature},           // Arguments
                fromUTXO.TxHash,               // SourceID
                fromUTXO.AssetID,              // AssetID
                fromUTXO.Amount,               // Amount
                fromUTXO.OutputIndex,          // SourcePosition
                fromUTXO.ControlProgram,       // ControlProgram
                nil,                           // StateData
            ),
        },
        Outputs: []*TxOutput{
            NewOriginalTxOutput(fromUTXO.AssetID, amount, toAddress, nil),
            NewOriginalTxOutput(fromUTXO.AssetID, change, fromUTXO.Address, nil),
        },
    }
}
```

**使用场景：**
- 用户之间转账BTM或其他资产
- 钱包应用创建交易
- 需要用户签名授权
- 需要支付手续费

---

## 六、核心区别总结

### 1. 输入来源

- **Coinbase交易**：无输入来源，`Arbitrary`字段仅用于存储元数据
- **普通交易**：必须引用已有的UTXO（通过`SourceID`和`SourcePosition`）

### 2. 资产来源

- **Coinbase交易**：直接铸新币，无资产来源
- **普通交易**：从已有UTXO中转移资产

### 3. 验证机制

- **Coinbase交易**：无需签名验证，系统自动验证
- **普通交易**：需要提供签名（`Arguments`），验证UTXO所有权

### 4. 发起权限

- **Coinbase交易**：只有矿工/出块节点可以创建
- **普通交易**：任何用户都可以创建

### 5. 成熟期限制

- **Coinbase交易**：需要等待`CoinbasePendingBlockNumber`个区块后才能花费（防止51%攻击）
- **普通交易**：一旦确认立即可用

---

## 七、与比特币/币安链的对比

比原链的交易类型设计与比特币、币安链逻辑一致：

| 特性 | 比特币 | 币安链 | 比原链 |
|------|--------|--------|--------|
| Coinbase交易 | ✅ 有 | ✅ 有 | ✅ 有 |
| 普通交易 | ✅ 有 | ✅ 有 | ✅ 有 |
| UTXO模型 | ✅ 是 | ✅ 是 | ✅ 是 |
| 交易结构 | Inputs + Outputs | Inputs + Outputs | Inputs + Outputs |

**主要区别在于：**
- 比原链支持多种资产类型（不仅限于BTM）
- 比原链的脚本系统（VM）更灵活
- 比原链的Coinbase交易包含`Arbitrary`字段，可存储更多元数据

---

## 相关资源

- [UTXO模型详解](./UTXO模型详解.md)
- [比原链技术文档](https://github.com/Bytom/bytom)
- [比特币白皮书](https://bitcoin.org/bitcoin.pdf)

---

**返回**: [第六章目录](./README.md)

