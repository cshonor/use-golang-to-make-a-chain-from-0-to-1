# 交易（Tx）基础数据结构

> 比原链交易的基础数据结构详解

---

## Tx 结构体定义

**文件位置：** `protocol/bc/types/transaction.go`

```go
// Tx 表示一笔交易，包含交易数据和交易哈希
type Tx struct {
    TxData           // 交易数据
    *bc.Tx `json:"-"` // 交易哈希（JSON序列化时忽略）
}
```

**说明：**
- `Tx` 是交易的顶层结构
- `TxData` 包含实际的交易数据
- `*bc.Tx` 包含交易的哈希值，用于快速查找和验证

---

## TxData 结构体定义

```go
// TxData 编码区块链中的交易数据
type TxData struct {
    Version        uint64        // 版本号
    SerializedSize uint64        // 交易总字节数
    TimeRange      uint64        // 交易过期时间
    Inputs         []*TxInput    // 交易输入数组
    Outputs        []*TxOutput   // 交易输出数组
}
```

---

## TxData 字段说明（表6-1）

| 字段 | 字节数 | 说明 |
|------|--------|------|
| `Version` | 8 | 版本号，标识交易格式版本 |
| `SerializedSize` | 8 | 交易总字节数，序列化后的大小 |
| `TimeRange` | 8 | 交易过期时间，0表示无过期限制 |
| `Inputs` | 不定长 | 交易输入数组，每个输入引用一个UTXO |
| `Outputs` | 不定长 | 交易输出数组，每个输出创建一个新的UTXO |

---

## 关键理解

### 1. Version（版本号）
- 用于标识交易格式的版本
- 不同版本可能有不同的字段或验证规则
- 当前主要使用版本 1

### 2. SerializedSize（序列化大小）
- 交易序列化后的字节数
- 用于计算交易手续费（通常按字节收费）
- 在序列化时自动计算

### 3. TimeRange（时间范围）
- 交易的有效时间范围
- 0 表示交易立即生效，无时间限制
- 非0值可用于实现时间锁定的交易

### 4. Inputs（输入数组）
- 数组类型，可以包含多个输入
- 每个输入引用一个之前交易的输出（UTXO）
- 输入类型可以是：
  - `CoinbaseInput`（币基输入）
  - `SpendInput`（花费输入）
  - `IssuanceInput`（发行输入）
  - `VetoInput`（否决输入）

### 5. Outputs（输出数组）
- 数组类型，可以包含多个输出
- 每个输出创建一个新的UTXO
- 输出类型可以是：
  - `OriginalOutputType`（普通输出）
  - `VoteOutputType`（投票输出）

---

## 如何判断交易类型（Coinbase vs 普通交易）

### 核心方法：检查 Inputs[0] 的 InputType()

```go
// 判断交易类型的函数
func IsCoinbaseTx(txData *TxData) bool {
    // 检查是否有输入
    if len(txData.Inputs) == 0 {
        return false
    }
    
    // 检查第一个输入的类型
    return txData.Inputs[0].InputType() == CoinbaseInputType
}

// 使用示例
func CheckTxType(tx *Tx) {
    if IsCoinbaseTx(&tx.TxData) {
        fmt.Println("这是 Coinbase 交易（币基交易）")
    } else {
        fmt.Println("这是普通交易（用户交易）")
    }
}
```

### 判断逻辑详解

**1. Coinbase 交易的特征：**
```go
// Coinbase 交易必须满足：
// 1. 至少有一个输入
// 2. 第一个输入的类型是 CoinbaseInputType
if len(txData.Inputs) > 0 && 
   txData.Inputs[0].InputType() == CoinbaseInputType {
    // 这是 Coinbase 交易
}
```

**2. 普通交易的特征：**
```go
// 普通交易的特征：
// 1. 至少有一个输入
// 2. 第一个输入的类型是 SpendInputType（或其他非Coinbase类型）
if len(txData.Inputs) > 0 && 
   txData.Inputs[0].InputType() == SpendInputType {
    // 这是普通交易
}
```

### 输入类型常量定义

```go
const (
    IssuanceInputType uint8 = iota  // 0: 发行输入
    SpendInputType                  // 1: 花费输入
    CoinbaseInputType               // 2: 币基输入
    VetoInputType                   // 3: 否决输入
)
```

### 实际代码示例（来自比原链源码）

```go
// 示例1: 计算交易手续费时判断
func txFee(tx *Tx) uint64 {
    // 如果是 Coinbase 交易，手续费为 0
    if len(tx.Inputs) == 1 && 
       tx.Inputs[0].InputType() == CoinbaseInputType {
        return 0
    }
    
    // 普通交易：手续费 = 输入总额 - 输出总额
    inputSum := uint64(0)
    outputSum := uint64(0)
    // ... 计算逻辑
    return inputSum - outputSum
}

// 示例2: 判断 UTXO 成熟期
func getValidHeight(tx *Tx, blockHeight uint64) uint64 {
    validHeight := blockHeight
    
    // Coinbase 交易的输出需要等待成熟期
    if tx.Inputs[0].InputType() == CoinbaseInputType {
        validHeight = blockHeight + CoinbasePendingBlockNumber
    }
    
    return validHeight
}
```

### 关键要点

1. **判断依据**：通过 `Inputs[0].InputType()` 判断，而不是其他字段
2. **Coinbase 交易**：第一个输入必须是 `CoinbaseInputType`
3. **普通交易**：第一个输入是 `SpendInputType` 或其他类型
4. **位置要求**：Coinbase 交易必须是区块的第一笔交易（索引0）
5. **唯一性**：一个区块只能有一笔 Coinbase 交易

### 在 JSON 中的体现

```json
{
  "inputs": [
    {
      "type": "coinbase",  // ← 这里标识是 Coinbase 交易
      "arbitrary": "..."
    }
  ]
}

// vs

{
  "inputs": [
    {
      "type": "spend",     // ← 这里标识是普通交易
      "spent_output_id": "...",
      "witness_arguments": [...]
    }
  ]
}
```

---

## 交易创建流程

```go
// 1. 创建交易数据
txData := TxData{
    Version:   1,
    TimeRange: 0,
    Inputs:    []*TxInput{...},
    Outputs:   []*TxOutput{...},
}

// 2. 创建交易对象（自动计算哈希）
tx := NewTx(txData)

// 3. 交易现在包含：
//    - tx.TxData: 交易数据
//    - tx.Tx: 交易哈希（用于查找和验证）
```

---

## 相关资源

- [比原链交易类型对比](./比原链交易类型对比.md)
- [交易Action数据结构详解](./交易Action数据结构详解.md) - Input/Output Action 类型详解
- [MUX交易类型详解](./MUX交易类型详解.md) - MUX多路复用结构说明
- [UTXO模型详解](./UTXO模型详解.md)
- [比原链技术文档](https://github.com/Bytom/bytom)

---

**返回**: [第六章目录](./README.md)

